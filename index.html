<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #111827; color: #f3f4f6; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .card-bg { background-color: #1f2937; border: 1px solid #374151; border-radius: 0.75rem; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="text-blue-400 animate-pulse text-xl font-bold"><i class="fas fa-circle-notch fa-spin mr-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <script>
        // --- State ---
        const state = {
            view: 'login', // login, lobby, room, game-role, game
            user: JSON.parse(localStorage.getItem('res_user') || 'null'),
            ws: null,
            connected: false,
            rooms: [],
            currentRoom: null,
            game: null,
            spies: [],
            serverUrl: localStorage.getItem('res_ws_url') || 'wss://test-pul.onrender.com',
            error: null
        };

        // --- Utils ---
        const $ = id => document.getElementById(id);
        const send = (type, payload = {}) => {
            if (state.ws && state.ws.readyState === 1) state.ws.send(JSON.stringify({ type, ...payload }));
        };
        const action = (name, data = {}) => send('action', { action: { name, ...data } });

        // --- Views ---
        function render() {
            const app = $('app');
            if (!app) return;
            
            if (state.error) {
                app.innerHTML = `
                    <div class="card-bg p-6 max-w-sm text-center shadow-xl">
                        <div class="text-red-500 text-5xl mb-4"><i class="fas fa-exclamation-circle"></i></div>
                        <h2 class="text-xl font-bold mb-2">–û—à–∏–±–∫–∞</h2>
                        <p class="text-gray-400 mb-6">${state.error}</p>
                        <button onclick="location.reload()" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg w-full">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    </div>`;
                return;
            }

            if (!state.connected) {
                app.innerHTML = `
                    <div class="card-bg p-8 max-w-sm w-full text-center fade-in">
                        <h1 class="text-3xl font-bold text-blue-500 mb-2">–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</h1>
                        <p class="text-gray-400 mb-6">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</p>
                        <div class="flex justify-center mb-6">
                            <i class="fas fa-circle-notch fa-spin text-4xl text-blue-500"></i>
                        </div>
                        <p class="text-xs text-gray-500 break-all mb-4">${state.serverUrl}</p>
                        <button onclick="changeServer()" class="text-blue-400 text-sm hover:underline">–ò–∑–º–µ–Ω–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
                    </div>`;
                return;
            }

            switch (state.view) {
                case 'login': return renderLogin();
                case 'lobby': return renderLobby();
                case 'room': return renderRoom();
                case 'game-role': return renderRoleReveal();
                case 'game': return renderGame();
                default: app.innerHTML = '<div>Unknown View</div>';
            }
        }

        function renderLogin() {
            $('app').innerHTML = `
                <div class="card-bg p-8 max-w-sm w-full fade-in shadow-2xl">
                    <h1 class="text-4xl font-black text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-2">RESISTANCE</h1>
                    <p class="text-center text-gray-400 mb-8">–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä–Ω–∞—è –∏–≥—Ä–∞</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">–í–∞—à–µ –∏–º—è</label>
                            <input id="inpName" type="text" class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-colors" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" value="${state.user?.name || ''}">
                        </div>
                        <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg transform transition active:scale-95">–í–æ–π—Ç–∏</button>
                    </div>
                </div>`;
        }

        function renderLobby() {
            const roomsList = state.rooms.map(r => `
                <div class="bg-gray-800 p-4 rounded-lg border border-gray-700 flex justify-between items-center hover:border-gray-500 transition-colors cursor-pointer" onclick="${r.hasPassword ? `joinPass('${r.id}')` : `join('${r.id}')`}">
                    <div>
                        <div class="font-bold text-white">${r.name}</div>
                        <div class="text-xs text-gray-400">–•–æ—Å—Ç: ${r.host}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        ${r.hasPassword ? '<i class="fas fa-lock text-yellow-500"></i>' : ''}
                        <span class="bg-gray-700 px-2 py-1 rounded text-xs font-mono">${r.players}/${r.maxPlayers}</span>
                    </div>
                </div>
            `).join('') || '<div class="text-center text-gray-500 py-8">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ–º–Ω–∞—Ç</div>';

            $('app').innerHTML = `
                <div class="w-full max-w-3xl fade-in p-4">
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h2 class="text-2xl font-bold">–õ–æ–±–±–∏</h2>
                            <p class="text-gray-400 text-sm">–ü—Ä–∏–≤–µ—Ç, ${state.user.name}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="showCreate()" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg"><i class="fas fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å</button>
                            <button onclick="logout()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm"><i class="fas fa-sign-out-alt"></i></button>
                        </div>
                    </div>

                    <div id="createForm" class="hidden mb-6 card-bg p-4">
                        <h3 class="font-bold mb-4">–ù–æ–≤–∞—è –∫–æ–º–Ω–∞—Ç–∞</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input id="cName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="bg-gray-900 border border-gray-700 rounded px-3 py-2 w-full">
                            <select id="cMax" class="bg-gray-900 border border-gray-700 rounded px-3 py-2 w-full">
                                <option value="5">5 –ò–≥—Ä–æ–∫–æ–≤</option>
                                <option value="6">6 –ò–≥—Ä–æ–∫–æ–≤</option>
                                <option value="7">7 –ò–≥—Ä–æ–∫–æ–≤</option>
                                <option value="8" selected>8 –ò–≥—Ä–æ–∫–æ–≤</option>
                                <option value="9">9 –ò–≥—Ä–æ–∫–æ–≤</option>
                            </select>
                            <input id="cPass" placeholder="–ü–∞—Ä–æ–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" class="bg-gray-900 border border-gray-700 rounded px-3 py-2 w-full md:col-span-2">
                        </div>
                        <div class="flex justify-end gap-2">
                            <button onclick="$('createForm').classList.add('hidden')" class="text-gray-400 px-4 py-2 hover:text-white">–û—Ç–º–µ–Ω–∞</button>
                            <button onclick="createRoom()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold">–°–æ–∑–¥–∞—Ç—å</button>
                        </div>
                    </div>

                    <div class="space-y-3">
                        ${roomsList}
                    </div>
                </div>`;
        }

        function renderRoom() {
            const r = state.currentRoom;
            const isHost = r.hostId === state.user.id;
            const link = `${location.origin}?room=${r.id}&invite=${r.inviteKey}`;
            
            const players = r.players.map(p => `
                <div class="flex items-center gap-3 bg-gray-800 p-3 rounded-lg border border-gray-700">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center font-bold text-sm">
                        ${p.name[0]}
                    </div>
                    <span>${p.name}</span>
                    ${p.id === r.hostId ? '<i class="fas fa-crown text-yellow-500 ml-auto"></i>' : ''}
                </div>
            `).join('');

            $('app').innerHTML = `
                <div class="max-w-2xl w-full fade-in p-4">
                    <button onclick="leaveRoom()" class="text-gray-400 hover:text-white mb-4"><i class="fas fa-arrow-left mr-2"></i>–ù–∞–∑–∞–¥ –≤ –ª–æ–±–±–∏</button>
                    
                    <div class="card-bg p-6 mb-6">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h1 class="text-3xl font-bold mb-1">${r.name}</h1>
                                <div class="text-gray-400 text-sm">–ò–≥—Ä–æ–∫–æ–≤: ${r.players.length} / ${r.maxPlayers}</div>
                            </div>
                            <button onclick="copyLink('${link}')" class="bg-gray-800 hover:bg-gray-700 text-blue-400 px-3 py-1 rounded text-xs border border-gray-600">
                                <i class="fas fa-link mr-1"></i>–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å
                            </button>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-8">
                            ${players}
                        </div>

                        ${isHost ? `
                            <button onclick="startGame()" ${r.players.length < 5 ? 'disabled' : ''} class="w-full bg-green-600 hover:bg-green-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl shadow-lg transition-transform active:scale-95 text-lg">
                                –ù–ê–ß–ê–¢–¨ –ò–ì–†–£
                            </button>
                            ${r.players.length < 5 ? '<p class="text-center text-xs text-gray-500 mt-2">–ú–∏–Ω–∏–º—É–º 5 –∏–≥—Ä–æ–∫–æ–≤</p>' : ''}
                        ` : `
                            <div class="text-center py-4 bg-gray-800 rounded-lg animate-pulse text-gray-400">
                                –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã...
                            </div>
                        `}
                    </div>
                </div>`;
        }

        function renderRoleReveal() {
            const me = state.game.you;
            const isSpy = me.role === 'spy';
            const confirmed = me.confirmedRole;
            
            // Spy list logic
            let spyContent = '';
            if (isSpy) {
                const others = state.spies.filter(s => s.id !== me.id);
                spyContent = `
                    <div class="mt-4 bg-red-900/30 border border-red-500/30 rounded p-4">
                        <p class="text-red-400 text-sm font-bold mb-2 uppercase">–í–∞—à–∏ —Å–æ—é–∑–Ω–∏–∫–∏:</p>
                        ${others.length ? others.map(s => `<div class="text-white">Agent ${s.spyNumber}: <b>${s.name}</b></div>`).join('') : '<div class="text-gray-400 text-sm">–ù–µ—Ç –¥—Ä—É–≥–∏—Ö —à–ø–∏–æ–Ω–æ–≤</div>'}
                    </div>`;
            }

            $('app').innerHTML = `
                <div class="max-w-md w-full fade-in p-4 text-center">
                    <h2 class="text-2xl font-bold mb-6">–í–∞—à–∞ —Ä–æ–ª—å</h2>
                    
                    <div class="card-bg p-8 mb-6 border-2 ${isSpy ? 'border-red-600' : 'border-blue-500'} relative overflow-hidden">
                        <div class="absolute inset-0 opacity-10 ${isSpy ? 'bg-red-600' : 'bg-blue-600'}"></div>
                        <div class="relative z-10">
                            <div class="text-6xl mb-4">${isSpy ? 'üïµÔ∏è' : 'üõ°Ô∏è'}</div>
                            <h1 class="text-3xl font-black uppercase mb-2 ${isSpy ? 'text-red-500' : 'text-blue-400'}">${isSpy ? '–®–ü–ò–û–ù' : '–°–û–ü–†–û–¢–ò–í–õ–ï–ù–ò–ï'}</h1>
                            <p class="text-gray-300 text-sm">${isSpy ? '–°–æ—Ä–≤–∏—Ç–µ 3 –º–∏—Å—Å–∏–∏. –ù–µ –¥–∞–π—Ç–µ —Å–µ–±—è —Ä–∞—Å–∫—Ä—ã—Ç—å.' : '–í—ã–ø–æ–ª–Ω–∏—Ç–µ 3 –º–∏—Å—Å–∏–∏. –í—ã—á–∏—Å–ª–∏—Ç–µ —à–ø–∏–æ–Ω–æ–≤.'}</p>
                            ${spyContent}
                        </div>
                    </div>

                    ${confirmed ? `
                        <div class="animate-pulse text-yellow-500 font-bold">
                            <i class="fas fa-clock mr-2"></i>–û–∂–∏–¥–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∏–≥—Ä–æ–∫–æ–≤...
                        </div>
                    ` : `
                        <button onclick="confirmRole()" class="w-full bg-gray-100 hover:bg-white text-gray-900 font-bold py-3 rounded-lg shadow-lg">
                            –Ø –ó–ê–ü–û–ú–ù–ò–õ –†–û–õ–¨
                        </button>
                    `}
                </div>`;
        }

        function renderGame() {
            const g = state.game;
            const me = g.you;
            
            // --- Helper Renders ---
            const renderTimer = (val) => `<div class="font-mono text-2xl font-bold ${val < 10 ? 'text-red-500' : 'text-white'}">${val}</div>`;
            
            const renderPhase = () => {
                if (g.phase === 'discussion') return `
                    <div class="text-center mb-6">
                        <div class="text-green-400 font-bold uppercase tracking-widest text-xs mb-1">–û–ë–°–£–ñ–î–ï–ù–ò–ï</div>
                        <div class="flex items-center justify-center gap-4">
                            ${renderTimer(g.discussionTimeLeft)}
                        </div>
                        <div class="mt-2 text-sm text-gray-400">
                             –•–æ–¥: <span class="text-white font-bold">${g.players[g.currentPlayerIndex].name}</span>
                             ${g.players[g.currentPlayerIndex].id === me.id ? '<span class="text-green-400 ml-2">(–í–´)</span>' : ''}
                        </div>
                        ${(g.players[g.currentPlayerIndex].id === me.id || state.currentRoom.hostId === me.id) ? 
                            `<button onclick="action('passTurn')" class="mt-4 bg-gray-700 hover:bg-gray-600 px-4 py-1 rounded text-xs">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ö–æ–¥ <i class="fas fa-forward ml-1"></i></button>` : ''}
                    </div>`;
                
                if (g.phase === 'leaderDiscussion') return `
                    <div class="text-center mb-6">
                         <div class="text-blue-400 font-bold uppercase tracking-widest text-xs mb-1">–õ–ò–î–ï–† –í–´–ë–†–ê–ù</div>
                         <div class="text-xl font-bold text-white mb-2"><i class="fas fa-crown text-yellow-500 mr-2"></i>${g.players.find(p => p.isLeader).name}</div>
                         <p class="text-gray-400 text-sm">–õ–∏–¥–µ—Ä –æ–±—Å—É–∂–¥–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É</p>
                         <div class="mt-2">${renderTimer(g.discussionTimeLeft)}</div>
                         ${(g.players[g.currentPlayerIndex].id === me.id || state.currentRoom.hostId === me.id) ? 
                            `<button onclick="action('passTurnLeaderDiscussion')" class="mt-4 bg-gray-700 hover:bg-gray-600 px-4 py-1 rounded text-xs">–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ö–æ–¥ <i class="fas fa-forward ml-1"></i></button>` : ''}
                    </div>`;

                if (g.phase === 'voting') return `
                    <div class="text-center mb-6">
                        <div class="text-yellow-400 font-bold uppercase tracking-widest text-xs mb-4">–ì–û–õ–û–°–û–í–ê–ù–ò–ï –ó–ê –õ–ò–î–ï–†–ê</div>
                        <div class="grid grid-cols-2 gap-3 max-w-md mx-auto">
                            ${(g.tieCandidates.length > 0 ? g.tieCandidates : g.nominatedPlayers).map(name => `
                                <button onclick="action('voteForLeader', {candidate: '${name}'})" class="bg-gray-800 hover:bg-gray-700 border border-gray-600 p-4 rounded-xl transition-all ${me.voted ? 'opacity-50 cursor-not-allowed' : ''}">
                                    <div class="font-bold text-lg text-white mb-1">${name}</div>
                                    <div class="text-xs text-gray-500">–ö–∞–Ω–¥–∏–¥–∞—Ç</div>
                                </button>
                            `).join('')}
                        </div>
                        ${me.voted ? '<div class="mt-4 text-green-500 animate-pulse">–ì–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç</div>' : ''}
                    </div>`;

                if (g.phase === 'tieDiscussion') return `
                    <div class="text-center mb-6">
                        <div class="text-red-400 font-bold uppercase tracking-widest text-xs mb-2">–ù–ò–ß–¨–Ø - –û–ë–°–£–ñ–î–ï–ù–ò–ï</div>
                        <p class="text-sm text-gray-400 mb-4">–ö–∞–Ω–¥–∏–¥–∞—Ç—ã: ${g.tieCandidates.join(', ')}</p>
                        ${renderTimer(g.tieTimeLeft)}
                    </div>`;

                if (g.phase === 'missionTeamSelection') return `
                    <div class="text-center mb-6">
                        <div class="text-purple-400 font-bold uppercase tracking-widest text-xs mb-1">–ù–ê–ë–û–† –ö–û–ú–ê–ù–î–´</div>
                        <div class="text-sm text-gray-400 mb-4">–ù—É–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å: <b class="text-white">${g.missionSizes[g.currentMission-1]}</b></div>
                        ${renderTimer(g.nominationTimeLeft)}
                        <div class="mt-4 flex flex-wrap justify-center gap-2">
                             ${g.missionTeam.map(n => `<span class="bg-purple-900 text-purple-200 px-3 py-1 rounded-full text-sm border border-purple-700">${n}</span>`).join('')}
                        </div>
                        ${me.isLeader ? `
                            <button onclick="action('approveTeam')" ${g.missionTeam.length !== g.missionSizes[g.currentMission-1] ? 'disabled' : ''} class="mt-4 bg-green-600 disabled:opacity-50 disabled:bg-gray-700 text-white px-8 py-2 rounded-lg font-bold shadow-lg">–£–¢–í–ï–†–î–ò–¢–¨</button>
                        ` : '<div class="mt-4 text-gray-500 animate-pulse">–õ–∏–¥–µ—Ä –≤—ã–±–∏—Ä–∞–µ—Ç...</div>'}
                    </div>`;

                if (g.phase === 'missionVoting') {
                    const inTeam = g.missionTeam.includes(me.name);
                    if (!inTeam) return `<div class="text-center p-8 text-gray-500">–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...<br>–í—ã –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—å.</div>`;
                    
                    if (me.missionVote) return `<div class="text-center p-8"><div class="text-green-500 text-xl font-bold mb-2"><i class="fas fa-check-circle"></i></div><div>–í—ã–±–æ—Ä —Å–¥–µ–ª–∞–Ω</div><div class="text-xs text-gray-500 mt-2">–û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã...</div></div>`;

                    const isSpy = me.role === 'spy';
                    const btns = [];
                    
                    const btn = (type, label, icon, color) => `
                        <button onclick="action('voteForMission', {vote: '${type}'})" class="bg-gray-800 hover:bg-${color}-900/30 border border-${color}-900 p-6 rounded-xl flex flex-col items-center gap-2 transition-transform active:scale-95">
                            <i class="fas ${icon} text-3xl text-${color}-500"></i>
                            <span class="font-bold text-${color}-400">${label}</span>
                        </button>`;

                    if (isSpy) {
                        btns.push(btn('success', '–£–°–ü–ï–•', 'fa-check', 'green'));
                        btns.push(btn('fail', '–ü–†–û–í–ê–õ', 'fa-times', 'red'));
                    } else {
                        btns.push(btn('success', '–£–°–ü–ï–•', 'fa-check', 'green'));
                        btns.push(btn('success', '–£–°–ü–ï–•', 'fa-check', 'green'));
                    }
                    btns.sort(() => Math.random() - 0.5);

                    return `
                        <div class="text-center mb-6">
                            <div class="text-orange-400 font-bold uppercase tracking-widest text-xs mb-8">–í–´–ë–û–† –ò–°–•–û–î–ê –ú–ò–°–°–ò–ò</div>
                            <div class="flex justify-center gap-4">
                                ${btns.join('')}
                            </div>
                        </div>`;
                }

                if (g.phase === 'missionResults') {
                    const last = g.missionResults[g.missionResults.length-1];
                    const win = last.success;
                    
                    if (g.gameOver) {
                         return `
                            <div class="text-center p-8 animate-bounce">
                                <h1 class="text-4xl font-black mb-4 ${g.winner === 'resistance' ? 'text-blue-500' : 'text-red-500'}">
                                    ${g.winner === 'resistance' ? '–ü–û–ë–ï–î–ê –°–û–ü–†–û–¢–ò–í–õ–ï–ù–ò–Ø!' : '–ü–û–ë–ï–î–ê –®–ü–ò–û–ù–û–í!'}
                                </h1>
                                <button onclick="leaveRoom()" class="bg-gray-700 text-white px-6 py-3 rounded-lg">–í—ã–π—Ç–∏ –≤ –ª–æ–±–±–∏</button>
                            </div>
                         `;
                    }

                    return `
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">${win ? '‚úÖ' : '‚ùå'}</div>
                            <h2 class="text-3xl font-bold mb-2 ${win ? 'text-green-500' : 'text-red-500'}">${win ? '–ú–ò–°–°–ò–Ø –£–°–ü–ï–®–ù–ê' : '–ú–ò–°–°–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê'}</h2>
                            <div class="flex justify-center gap-8 mt-6 text-sm">
                                <div class="text-green-400">–£—Å–ø–µ—Ö: <b>${last.successCount}</b></div>
                                <div class="text-red-400">–ü—Ä–æ–≤–∞–ª: <b>${last.failCount}</b></div>
                            </div>
                            ${state.currentRoom.hostId === me.id ? 
                                `<button onclick="action('nextMission')" class="mt-8 bg-blue-600 text-white px-8 py-2 rounded-lg font-bold">–î–∞–ª–µ–µ</button>` : 
                                '<div class="mt-8 text-gray-500">–•–æ—Å—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç —Å–ª–µ–¥. —Ä–∞—É–Ω–¥...</div>'}
                        </div>`;
                }

                return '';
            };

            // --- Main Layout ---
            $('app').innerHTML = `
                <div class="w-full max-w-5xl fade-in p-2 md:p-4 grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Left Sidebar (Stats) -->
                    <div class="hidden md:block col-span-1 space-y-4">
                        <div class="card-bg p-4">
                            <h3 class="text-xs font-bold text-gray-500 uppercase mb-2">–ú–∏—Å—Å–∏—è ${g.currentMission}</h3>
                            <div class="flex justify-between items-center mb-1 text-sm">
                                <span class="text-green-400">–£—Å–ø–µ—Ö: ${g.successfulMissions}</span>
                                <span class="text-red-400">–ü—Ä–æ–≤–∞–ª: ${g.failedMissions}</span>
                            </div>
                            <div class="flex gap-1 h-2 bg-gray-700 rounded overflow-hidden">
                                ${g.missionSizes.map((s, i) => {
                                    const res = g.missionResults.find(r => r.mission === i+1);
                                    let col = 'bg-gray-600';
                                    if (res) col = res.success ? 'bg-green-500' : 'bg-red-500';
                                    else if (i+1 === g.currentMission) col = 'bg-blue-500 animate-pulse';
                                    return `<div class="flex-1 ${col}"></div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Center (Game Area) -->
                    <div class="col-span-1 md:col-span-2 card-bg p-4 min-h-[400px] flex flex-col justify-center relative">
                        <!-- Top Info -->
                        <div class="absolute top-4 left-4 right-4 flex justify-between text-xs text-gray-500">
                            <div>Mission ${g.currentMission} (${g.missionSizes[g.currentMission-1]} —á–µ–ª.)</div>
                            ${g.phase.includes('mission') ? '' : `<div>Leader: ${g.players.find(p=>p.isLeader)?.name}</div>`}
                        </div>
                        
                        ${renderPhase()}
                    </div>

                    <!-- Right Sidebar (Players) -->
                    <div class="col-span-1 space-y-2 max-h-[400px] overflow-y-auto">
                        <h3 class="text-xs font-bold text-gray-500 uppercase px-1">–ò–≥—Ä–æ–∫–∏</h3>
                        ${g.players.map(p => {
                            const isLead = p.isLeader;
                            const isNom = g.nominatedPlayers.includes(p.name);
                            const inTeam = g.missionTeam.includes(p.name);
                            
                            // Click handler
                            let onclick = '';
                            if (g.phase === 'discussion' || g.phase === 'nomination') onclick = `action('nominate', {target: '${p.name}'})`;
                            if (g.phase === 'missionTeamSelection' && me.isLeader) onclick = `action('toggleTeamMember', {target: '${p.name}'})`;
                            
                            return `
                                <div onclick="${onclick}" class="flex items-center gap-2 p-2 rounded border border-transparent ${onclick ? 'hover:bg-gray-800 cursor-pointer' : ''} ${isNom ? 'border-yellow-500/50 bg-yellow-900/10' : ''} ${inTeam ? 'border-purple-500/50 bg-purple-900/10' : ''}">
                                    <div class="relative">
                                        <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-xs font-bold">${p.name[0]}</div>
                                        ${isLead ? '<div class="absolute -top-1 -right-1 text-yellow-500 text-xs"><i class="fas fa-crown"></i></div>' : ''}
                                    </div>
                                    <div class="text-sm truncate flex-1 ${p.id === me.id ? 'text-blue-400' : 'text-gray-300'}">${p.name}</div>
                                    ${isNom ? '<i class="fas fa-hand-paper text-yellow-500 text-xs"></i>' : ''}
                                    ${inTeam ? '<i class="fas fa-user-astronaut text-purple-400 text-xs"></i>' : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>`;
        }


        // --- Actions ---
        window.login = () => {
            const name = $('inpName').value.trim();
            if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
            const id = state.user?.id || 'u_' + Math.random().toString(36).substr(2, 9);
            state.user = { id, name };
            localStorage.setItem('res_user', JSON.stringify(state.user));
            connect();
        };

        window.logout = () => {
            localStorage.removeItem('res_user');
            location.reload();
        };

        window.changeServer = () => {
            const url = prompt('URL —Å–µ—Ä–≤–µ—Ä–∞:', state.serverUrl);
            if (url) {
                localStorage.setItem('res_ws_url', url);
                state.serverUrl = url;
                location.reload();
            }
        };
        
        window.showCreate = () => $('createForm').classList.remove('hidden');
        
        window.createRoom = () => {
            send('createRoom', {
                name: $('cName').value || `${state.user.name}'s Game`,
                maxPlayers: parseInt($('cMax').value),
                password: $('cPass').value
            });
        };

        window.join = (roomId) => send('joinRoom', { roomId });
        window.joinPass = (roomId) => {
            const p = prompt('–ü–∞—Ä–æ–ª—å:');
            if (p !== null) send('joinRoom', { roomId, password: p });
        };
        
        window.leaveRoom = () => send('leaveRoom');
        window.copyLink = (txt) => { navigator.clipboard.writeText(txt); alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); };
        window.startGame = () => send('startGame');
        window.confirmRole = () => action('confirmRole');

        // --- Core ---
        function connect() {
            state.view = 'lobby'; // Optimistic switch, will render loader
            render(); 

            try {
                state.ws = new WebSocket(state.serverUrl);
                
                state.ws.onopen = () => {
                    state.connected = true;
                    // Initial Hello
                    const params = new URLSearchParams(location.search);
                    send('hello', { userId: state.user.id, name: state.user.name });
                    
                    // Auto join via link
                    const roomId = params.get('room');
                    const invite = params.get('invite');
                    if (roomId && invite) {
                        send('joinRoom', { roomId, inviteKey: invite });
                        // Clear URL to prevent rejoin on reload
                        window.history.replaceState({}, document.title, "/");
                    }
                };

                state.ws.onclose = () => {
                    state.connected = false;
                    setTimeout(connect, 3000); // Reconnect
                    render();
                };

                state.ws.onmessage = (msg) => {
                    const data = JSON.parse(msg.data);
                    
                    if (data.type === 'lobby') {
                        state.rooms = data.rooms;
                        if (state.view === 'lobby') render();
                    }

                    if (data.type === 'room') {
                        state.currentRoom = data.room;
                        if (!state.game) state.view = 'room';
                        render();
                    }
                    
                    if (data.type === 'game') {
                        state.game = data.game;
                        if (data.spies) state.spies = data.spies;
                        
                        if (state.game.phase === 'roleReveal') state.view = 'game-role';
                        else state.view = 'game';
                        
                        render();
                    }

                    if (data.type === 'error') {
                        alert(data.message);
                    }
                };

            } catch (e) {
                state.error = "–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + e.message;
                render();
            }
        }

        // Init
        if (state.user) {
            connect();
        } else {
            render();
        }
    </script>
</body>
</html>
