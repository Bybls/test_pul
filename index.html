<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сопротивление - Мультиплеерная игра</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .timer-bar { transition: width 1s linear; }
        .role-card { perspective: 1000px; }
        .role-card-inner { transition: transform 0.8s; transform-style: preserve-3d; position: relative; width: 100%; height: 260px; }
        .role-card.flipped .role-card-inner { transform: rotateY(180deg); }
        .role-card-front, .role-card-back { backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 0.75rem; }
        .role-card-back { transform: rotateY(180deg); }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 text-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl"></div>

    <script>
        // --- Global State ---
        const gameState = {
            currentView: 'login', // login, lobby, game-room, game
            user: null,
            rooms: [],
            currentRoom: null, // {id, name, host, hostId, maxPlayers, hasPassword, inviteKey, playersList: []}
            gameData: null,    // server-synced game object (masked for others)
            spiesList: [],     // only for current spy
            ws: null,
            wsConnected: false,
            pendingInvite: null, // {roomId, inviteKey}
            // connection mgmt
            serverWsUrl: null,
            reconnectAttempts: 0,
            reconnectTimerId: null,
            connectionTimeoutId: null,
            connecting: false,
            lastError: null,
            creatingRoom: false,
            lastActionError: null,
            creationTimeoutId: null
        };

        // --- Helpers ---
        const byId = (id) => document.getElementById(id);

        const computeDefaultWsUrl = () => {
            // Check URL parameter ?server=wss://example.com
            const params = new URLSearchParams(location.search);
            const serverParam = params.get('server');
            if (serverParam && serverParam.startsWith('ws')) {
                return serverParam.trim();
            }
            
            // Default to public Render server for most cases (except local file)
            if (location.protocol === 'file:' && !location.host) {
                // Local file opened directly - default to localhost for testing
                return 'ws://localhost:8080';
            }
            
            // For HTTPS sites (GitHub Pages, Netlify, etc.) or any web deployment
            // use the public Render server
            return 'wss://test-pul.onrender.com';
        };
        const wsUrl = () => gameState.serverWsUrl || localStorage.getItem('resistanceServerWsUrl') || computeDefaultWsUrl();

        const generateDeviceId = () => {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        };
        const sendWS = (payload) => {
            if (gameState.ws && gameState.ws.readyState === WebSocket.OPEN) {
                try {
                    gameState.ws.send(JSON.stringify(payload));
                    console.log('Отправлено сообщение:', payload.type, payload);
                } catch (e) {
                    console.error('Ошибка отправки сообщения:', e);
                    gameState.lastError = 'Ошибка отправки данных. Соединение может быть разорвано.';
                    renderApp();
                }
            } else {
                console.error('WebSocket не подключен, состояние:', gameState.ws?.readyState);
                gameState.lastError = 'Соединение с сервером отсутствует.';
                renderApp();
            }
        };
        const sendAction = (name, extra = {}) => sendWS({ type: 'action', action: { name, ...extra } });

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            gameState.serverWsUrl = localStorage.getItem('resistanceServerWsUrl') || computeDefaultWsUrl();

            const savedUser = localStorage.getItem('resistanceUser');
            const params = new URLSearchParams(location.search);
            const inviteRoom = params.get('room');
            const inviteKey = params.get('invite');

            if (savedUser) {
                gameState.user = JSON.parse(savedUser);
                // Если есть сохранённый пользователь, показываем лобби, но если соединения нет,
                // пользователь увидит предупреждение и сможет выйти или попробовать подключиться.
                gameState.currentView = 'lobby';
                connectWS();
            } else {
                gameState.currentView = 'login';
                renderApp();
                // Try to connect early to show status
                connectWS();
            }

            if (inviteRoom && inviteKey) {
                gameState.pendingInvite = { roomId: inviteRoom, inviteKey };
            }
        });

        function connectWS() {
            try { if (gameState.ws) { try { gameState.ws.close(); } catch {} } } catch {}
            if (gameState.reconnectTimerId) { clearTimeout(gameState.reconnectTimerId); gameState.reconnectTimerId = null; }
            if (gameState.connectionTimeoutId) { clearTimeout(gameState.connectionTimeoutId); gameState.connectionTimeoutId = null; }
            if (gameState.creationTimeoutId) { clearTimeout(gameState.creationTimeoutId); gameState.creationTimeoutId = null; }

            let url = wsUrl();
            console.log('Попытка подключения к WebSocket:', url);
            gameState.connecting = true;
            gameState.wsConnected = false;
            gameState.lastError = null;
            gameState.creatingRoom = false;
            gameState.lastActionError = null;
            renderApp();
            
            try {
                gameState.ws = new WebSocket(url);
            } catch (e) {
                console.error('Ошибка создания WebSocket:', e.message);
                gameState.wsConnected = false;
                gameState.connecting = false;
                gameState.lastError = `Ошибка создания WebSocket: ${e.message}`;
                scheduleReconnect();
                renderApp();
                return;
            }

            // Таймаут подключения (10 секунд)
            gameState.connectionTimeoutId = setTimeout(() => {
                if (!gameState.wsConnected && gameState.connecting) {
                    console.error('Таймаут подключения WebSocket');
                    gameState.ws.close();
                    gameState.wsConnected = false;
                    gameState.connecting = false;
                    gameState.lastError = 'Таймаут подключения. Сервер не отвечает.';
                    scheduleReconnect();
                    renderApp();
                }
            }, 10000);

            gameState.ws.onopen = () => {
                console.log('WebSocket подключение установлено');
                if (gameState.connectionTimeoutId) {
                    clearTimeout(gameState.connectionTimeoutId);
                    gameState.connectionTimeoutId = null;
                }
                gameState.wsConnected = true;
                gameState.connecting = false;
                gameState.lastError = null;
                gameState.reconnectAttempts = 0;
                if (gameState.reconnectTimerId) { 
                    clearTimeout(gameState.reconnectTimerId); 
                    gameState.reconnectTimerId = null; 
                }
                if (gameState.user) {
                    sendWS({ type: 'hello', userId: gameState.user.id, name: gameState.user.name });
                    sendWS({ type: 'getLobby' });
                    // auto-join by invite
                    if (gameState.pendingInvite) {
                        const { roomId, inviteKey } = gameState.pendingInvite;
                        sendWS({ type: 'joinRoom', roomId, inviteKey });
                        gameState.pendingInvite = null;
                    }
                } else {
                    // Not logged in yet, just fetch lobby to show that server is alive
                    sendWS({ type: 'getLobby' });
                }
                renderApp();
            };
            gameState.ws.onmessage = (e) => handleServerMessage(e.data);
            gameState.ws.onclose = () => { 
                console.log('WebSocket соединение закрыто');
                if (gameState.connectionTimeoutId) {
                    clearTimeout(gameState.connectionTimeoutId);
                    gameState.connectionTimeoutId = null;
                }
                gameState.wsConnected = false; 
                gameState.connecting = false;
                renderApp(); 
                scheduleReconnect(); 
            };
            gameState.ws.onerror = (err) => { 
                console.error('WebSocket ошибка:', err); 
                if (gameState.connectionTimeoutId) {
                    clearTimeout(gameState.connectionTimeoutId);
                    gameState.connectionTimeoutId = null;
                }
                gameState.wsConnected = false; 
                gameState.connecting = false;
                gameState.lastError = 'Не удалось подключиться к серверу. Проверьте адрес и запущен ли сервер.';
                renderApp(); 
            };
        }

        function scheduleReconnect() {
            const attempt = Math.min(gameState.reconnectAttempts + 1, 10);
            gameState.reconnectAttempts = attempt;
            const delay = Math.min(30000, Math.pow(2, attempt - 1) * 1000); // 1s,2s,4s,8s... up to 30s
            if (gameState.reconnectTimerId) return;
            gameState.reconnectTimerId = setTimeout(() => {
                gameState.reconnectTimerId = null;
                connectWS();
            }, delay);
        }

        function handleServerMessage(raw) {
            let data; try { data = JSON.parse(raw); } catch { return; }
            console.log('Получено от сервера:', data.type, data);
            
            if (data.type === 'lobby') {
                gameState.rooms = (data.rooms || []).map(r => ({
                    id: r.id, name: r.name, host: r.host, hostId: r.hostId,
                    players: r.players, maxPlayers: r.maxPlayers,
                    hasPassword: !!r.hasPassword
                }));
                if (gameState.currentView === 'login') gameState.currentView = 'lobby';
                renderApp();
                return;
            }
            if (data.type === 'room') {
                const r = data.room || {};
                gameState.currentRoom = {
                    id: r.id, name: r.name, host: r.host, hostId: r.hostId,
                    maxPlayers: r.maxPlayers, hasPassword: !!r.hasPassword,
                    inviteKey: r.inviteKey || null,
                    playersList: (data.players || []).map(p => ({ id: p.id, name: p.name }))
                };
                gameState.creatingRoom = false;
                gameState.lastActionError = null;
                if (gameState.creationTimeoutId) {
                    clearTimeout(gameState.creationTimeoutId);
                    gameState.creationTimeoutId = null;
                }
                if (gameState.currentView !== 'game') gameState.currentView = 'game-room';
                renderApp();
                return;
            }
            if (data.type === 'game') {
                gameState.gameData = data.game || null;
                gameState.spiesList = data.spies || [];
                gameState.creatingRoom = false;
                gameState.lastActionError = null;
                if (gameState.currentView !== 'game') gameState.currentView = 'game';
                renderApp();
                return;
            }
            if (data.type === 'chat') {
                console.log('CHAT', data.from + ':', data.message);
                return;
            }
            if (data.type === 'error') {
                gameState.creatingRoom = false;
                gameState.lastActionError = data.message || 'Ошибка';
                if (gameState.creationTimeoutId) {
                    clearTimeout(gameState.creationTimeoutId);
                    gameState.creationTimeoutId = null;
                }
                alert(data.message || 'Ошибка');
                renderApp();
                return;
            }
        }

        // --- Render Root ---
        function renderApp() {
            const app = byId('app');
            if (!app) return;
            switch (gameState.currentView) {
                case 'login': app.innerHTML = renderLoginView(); break;
                case 'lobby': app.innerHTML = renderLobbyView(); break;
                case 'game-room': app.innerHTML = renderGameRoomView(); break;
                case 'game': app.innerHTML = renderGameView(); break;
                default: app.innerHTML = '<div>Загрузка...</div>';
            }
        }

        function connectionControlsInline() {
            const connected = gameState.wsConnected;
            const connecting = gameState.connecting;
            const url = wsUrl();
            let statusText = '';
            let statusClass = '';
            let statusIcon = '';
            
            if (connecting) {
                statusText = 'Подключение...';
                statusClass = 'bg-yellow-700 text-yellow-200';
                statusIcon = 'fa-spinner fa-spin';
            } else if (connected) {
                statusText = 'Подключено';
                statusClass = 'bg-green-700 text-green-200';
                statusIcon = 'fa-circle-check';
            } else {
                statusText = 'Нет соединения';
                statusClass = 'bg-red-700 text-red-200';
                statusIcon = 'fa-circle-xmark';
            }
            
            return `
                <div class="flex flex-wrap items-center gap-2">
                    <span class="inline-flex items-center text-xs px-2 py-1 rounded-full ${statusClass}">
                        <i class="fas ${statusIcon} mr-1"></i>${statusText}
                    </span>
                    ${gameState.reconnectAttempts > 0 ? `<span class="text-xs text-gray-400">Попытка ${gameState.reconnectAttempts}</span>` : ''}
                    <span class="text-xs text-gray-400 truncate max-w-[200px]" title="${url}"><i class="fas fa-plug mr-1"></i>${url}</span>
                    <button onclick="reconnectNow()" class="text-xs bg-gray-700 hover:bg-gray-600 border border-gray-600 px-2 py-1 rounded"><i class="fas fa-rotate mr-1"></i>Подключиться</button>
                    <button onclick="promptServerUrl()" class="text-xs bg-gray-700 hover:bg-gray-600 border border-gray-600 px-2 py-1 rounded"><i class="fas fa-gear mr-1"></i>Настройки</button>
                </div>
            `;
        }

        // --- Views ---
        function renderLoginView() {
            return `
                <div class="max-w-md mx-auto bg-gray-800 rounded-xl shadow-2xl p-8 mt-12">
                    <div class="flex items-start justify-between mb-4">
                        <div class="text-left">
                            <h1 class="text-4xl font-bold text-blue-400 mb-2">Сопротивление</h1>
                            <p class="text-gray-300">Мультиплеерная игра для 5-9 игроков</p>
                        </div>
                        ${connectionControlsInline()}
                    </div>
                    ${!gameState.wsConnected ? `
                        <div class="mb-6 bg-gradient-to-r from-red-900/40 to-red-800/30 border border-red-700 rounded-xl p-4">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-server text-red-400 text-xl mr-3"></i>
                                <h3 class="text-lg font-bold text-white">Сервер не подключен</h3>
                            </div>
                            ${gameState.lastError ? `<div class="mb-3 p-3 bg-red-900/50 border border-red-800 rounded"><p class="text-red-200 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>${gameState.lastError}</p></div>` : ''}
                            <p class="text-gray-300 text-sm mb-3">Для игры необходимо запустить сервер на вашем компьютере или подключиться к существующему серверу.</p>
                            <div class="space-y-4">
                                <div>
                                    <p class="text-gray-400 text-sm"><i class="fas fa-terminal mr-2"></i>Чтобы запустить сервер, выполните в терминале:</p>
                                    <div class="bg-gray-900 border border-gray-700 rounded p-3 font-mono text-sm">
                                        npm install<br>
                                        npm start
                                    </div>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-sm"><i class="fas fa-plug mr-2"></i>Для локального тестирования: <span class="font-mono text-blue-300">ws://localhost:8080</span></p>
                                    <p class="text-gray-400 text-sm">Для игры с друзьями используйте публичный сервер: <span class="font-mono text-green-300">wss://test-pul.onrender.com</span></p>
                                    <p class="text-gray-400 text-sm mt-1"><i class="fas fa-info-circle mr-1"></i>Публичный сервер на Render.com может просыпаться до 1 минуты при первом подключении.</p>
                                    <p class="text-gray-400 text-sm">Вы можете указать адрес сервера в настройках выше или добавить параметр в URL: <code class="font-mono text-yellow-300">?server=wss://ваш-сервер</code></p>
                                    <p class="text-gray-400 text-sm">Если открываете с GitHub Pages, автоматически будет использован адрес <span class="font-mono text-green-300">wss://test-pul.onrender.com</span></p>
                                </div>
                                <div>
                                    <p class="text-gray-400 text-sm"><i class="fas fa-question-circle mr-2"></i>Возможные причины проблемы:</p>
                                    <ul class="text-gray-400 text-sm list-disc list-inside ml-4 mt-1 space-y-1">
                                        <li>Сервер не запущен — проверьте, выполнили ли вы команду <code class="bg-gray-800 px-1 rounded">npm start</code></li>
                                        <li>Порт 8080 занят другой программой — попробуйте изменить порт в настройках сервера</li>
                                        <li>Брандмауэр блокирует подключение — разрешите подключения на порту 8080</li>
                                        <li>Не установлены зависимости — выполните <code class="bg-gray-800 px-1 rounded">npm install</code></li>
                                        <li>Вы используете неверный адрес сервера — проверьте настройки подключения</li>
                                        <li>Публичный сервер спит — подождите до 1 минуты и повторите попытку</li>
                                    </ul>
                                </div>
                                <div class="pt-2 flex space-x-3">
                                    <button onclick="reconnectNow()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-semibold py-2 px-4 rounded-lg transition">
                                        <i class="fas fa-redo mr-2"></i>Повторить попытку подключения
                                    </button>
                                    <button onclick="promptServerUrl()" class="flex-1 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold py-2 px-4 rounded-lg transition">
                                        <i class="fas fa-gear mr-2"></i>Настройки сервера
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    <div class="mb-6">
                        <label class="block text-gray-300 mb-2" for="username">Имя игрока</label>
                        <input type="text" id="username" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Введите ваше имя">
                        <p class="text-sm text-gray-400 mt-2">Имя будет видно другим игрокам</p>
                    </div>
                    <div class="mb-8">
                        <label class="block text-gray-300 mb-2" for="deviceId">ID устройства</label>
                        <input type="text" id="deviceId" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg" value="${generateDeviceId()}" readonly>
                        <p class="text-sm text-gray-400 mt-2">Автоматически сгенерированный ID вашего устройства</p>
                    </div>
                    <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-semibold py-3 px-4 rounded-lg transition">
                        <i class="fas fa-sign-in-alt mr-2"></i>Войти в игру
                    </button>
                    <div class="mt-6 pt-6 border-t border-gray-700 text-center">
                        <p class="text-gray-400 text-sm">Нужна помощь? <a href="javascript:void(0);" onclick="showHelp()" class="text-blue-400 hover:text-blue-300 underline">Инструкция по запуску</a></p>
                    </div>
                </div>
            `;
        }

        function handleLogin() {
            const username = byId('username')?.value?.trim();
            const deviceId = byId('deviceId')?.value;
            if (!username) { alert('Пожалуйста, введите имя игрока'); return; }
            gameState.user = { id: deviceId, name: username, deviceId };
            localStorage.setItem('resistanceUser', JSON.stringify(gameState.user));
            gameState.currentView = 'lobby';
            if (!gameState.wsConnected) connectWS();
            renderApp();
        }

        function renderLobbyView() {
            return `
                <div class="mb-8">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                        <div class="w-full md:w-auto">
                            <h1 class="text-3xl font-bold text-blue-400">Лобби игры</h1>
                            <p class="text-gray-300">Добро пожаловать, ${gameState.user?.name || ''}!</p>
                            ${!gameState.wsConnected ? '<p class="text-sm text-red-400">Нет соединения с сервером...</p>' : ''}
                        </div>
                        <div class="flex flex-col md:flex-row items-center gap-3 mt-4 md:mt-0">
                            ${connectionControlsInline()}
                            <div class="flex items-center gap-3">
                                <button onclick="showCreateRoomForm()" class="bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 text-white font-semibold py-2 px-6 rounded-lg transition flex items-center">
                                    <i class="fas fa-plus mr-2"></i>Создать комнату
                                </button>
                                <button onclick="logout()" class="bg-gradient-to-r from-gray-700 to-gray-800 hover:from-gray-800 hover:to-gray-900 text-white font-semibold py-2 px-6 rounded-lg transition border border-gray-600">
                                    <i class="fas fa-sign-out-alt mr-2"></i>Выйти
                                </button>
                            </div>
                        </div>
                    </div>
                    ${!gameState.wsConnected ? `
                        <div class="mb-6 bg-gradient-to-r from-red-900/40 to-red-800/30 border border-red-700 rounded-xl p-6">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-server text-red-400 text-xl mr-3"></i>
                                <h3 class="text-lg font-bold text-white">Сервер не подключен</h3>
                            </div>
                            ${gameState.lastError ? `<div class="mb-3 p-3 bg-red-900/50 border border-red-800 rounded"><p class="text-red-200 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>${gameState.lastError}</p></div>` : ''}
                            <p class="text-gray-300 text-sm mb-3">Для создания комнаты и игры необходимо подключиться к серверу.</p>
                            <div class="space-y-4">
                                <div>
                                    <p class="text-gray-400 text-sm"><i class="fas fa-plug mr-2"></i>Текущий адрес сервера: <span class="font-mono text-blue-300">${wsUrl()}</span></p>
                                    <p class="text-gray-400 text-sm">Для локального тестирования используйте <span class="font-mono text-green-300">ws://localhost:8080</span></p>
                                    <p class="text-gray-400 text-sm">Для игры с друзьями используйте публичный сервер: <span class="font-mono text-green-300">wss://test-pul.onrender.com</span></p>
                                    <p class="text-gray-400 text-sm mt-1"><i class="fas fa-info-circle mr-1"></i>Публичный сервер на Render.com может просыпаться до 1 минуты при первом подключении.</p>
                                </div>
                                <div class="pt-2 flex space-x-3">
                                    <button onclick="reconnectNow()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-semibold py-2 px-4 rounded-lg transition">
                                        <i class="fas fa-redo mr-2"></i>Повторить попытку подключения
                                    </button>
                                    <button onclick="promptServerUrl()" class="flex-1 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold py-2 px-4 rounded-lg transition">
                                        <i class="fas fa-gear mr-2"></i>Настройки сервера
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}

                    <div id="createRoomCard" class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg mb-6 hidden">
                        <h3 class="text-xl font-bold text-green-400 mb-4">Создать новую игру</h3>
                        <div class="mb-4">
                            <label class="block text-gray-300 mb-2">Количество игроков</label>
                            <select id="playerCount" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
                                <option value="5">5 игроков (2 шпиона)</option>
                                <option value="6">6 игроков (2 шпиона)</option>
                                <option value="7">7 игроков (3 шпиона)</option>
                                <option value="8" selected>8 игроков (3 шпиона)</option>
                                <option value="9">9 игроков (3 шпиона)</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label class="flex items-center text-gray-300">
                                <input type="checkbox" id="usePassword" class="mr-2 h-5 w-5 text-green-500 rounded">Защитить паролем
                            </label>
                            <input type="password" id="roomPassword" class="w-full mt-2 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg hidden" placeholder="Введите пароль">
                        </div>
                        <button onclick="createRoomFromForm()" ${gameState.creatingRoom ? 'disabled' : ''} class="w-full bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center ${gameState.creatingRoom ? 'opacity-75 cursor-not-allowed' : ''}">
                            ${gameState.creatingRoom ? `
                                <i class="fas fa-spinner fa-spin mr-2"></i>Создание комнаты...
                            ` : `
                                <i class="fas fa-gamepad mr-2"></i>Создать игровую комнату
                            `}
                        </button>
                        ${gameState.lastActionError ? `
                            <div class="mt-4 p-3 bg-red-900/50 border border-red-700 rounded">
                                <p class="text-red-200 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>${gameState.lastActionError}</p>
                            </div>
                        ` : ''}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${gameState.rooms.length > 0 ? gameState.rooms.map(room => `
                            <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="text-xl font-bold text-blue-400">${room.name}</h3>
                                        <p class="text-gray-300">Создатель: ${room.host}</p>
                                    </div>
                                    <div class="bg-gray-700 text-white text-sm font-semibold px-3 py-1 rounded-full">${room.players}/${room.maxPlayers}</div>
                                </div>
                                <div class="mb-6">
                                    <div class="flex items-center text-gray-300 mb-2">
                                        <i class="fas ${room.hasPassword ? 'fa-lock text-red-400' : 'fa-lock-open text-green-400'} mr-2"></i>
                                        ${room.hasPassword ? 'Требуется пароль' : 'Без пароля'}
                                    </div>
                                </div>
                                <div class="flex space-x-3">
                                    ${room.hasPassword ? `
                                        <button onclick="joinRoomWithPassword('${room.id}')" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-semibold py-2 px-4 rounded-lg">Войти</button>
                                    ` : `
                                        <button onclick="joinRoom('${room.id}')" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-semibold py-2 px-4 rounded-lg">Присоединиться</button>
                                    `}
                                </div>
                            </div>
                        `).join('') : `
                            <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg lg:col-span-2">
                                <div class="text-center py-8">
                                    <i class="fas fa-door-open text-4xl text-gray-500 mb-4"></i>
                                    <h3 class="text-xl font-bold text-gray-400 mb-2">Нет активных комнат</h3>
                                    <p class="text-gray-500">Создайте первую комнату или попросите друга создать игру</p>
                                </div>
                            </div>
                        `}
                    </div>

                    <div class="bg-gradient-to-br from-blue-900/30 to-indigo-900/20 border border-blue-800 rounded-xl p-6 shadow-lg mt-8">
                        <h2 class="text-2xl font-bold text-blue-400 mb-4">Игра с разных устройств</h2>
                        <p class="text-gray-300">Комнаты создаются только реальными игроками и доступны всем устройствам через сервер. Для входа без пароля используйте ссылку-приглашение из комнаты ожидания.</p>
                    </div>
                </div>
            `;
        }

        function showCreateRoomForm() {
            const card = byId('createRoomCard');
            if (card) card.classList.toggle('hidden');
        }

        function createRoomFromForm() {
            if (!gameState.wsConnected) { 
                alert('Нет соединения с сервером'); 
                return; 
            }
            if (gameState.creatingRoom) return;
            
            const playerCount = parseInt(byId('playerCount').value);
            const usePassword = byId('usePassword').checked;
            const password = byId('roomPassword').value;
            if (usePassword && !password) { 
                alert('Пожалуйста, введите пароль для комнаты'); 
                return; 
            }
            
            gameState.creatingRoom = true;
            gameState.lastActionError = null;
            if (gameState.creationTimeoutId) {
                clearTimeout(gameState.creationTimeoutId);
                gameState.creationTimeoutId = null;
            }
            renderApp();
            
            console.log('Создание комнаты:', { maxPlayers: playerCount, hasPassword: usePassword });
            sendWS({ 
                type: 'createRoom', 
                name: `Игра ${gameState.user.name}`, 
                maxPlayers: playerCount, 
                password: usePassword ? password : null 
            });
            
            // Таймаут на случай, если ответ не придет
            gameState.creationTimeoutId = setTimeout(() => {
                if (gameState.creatingRoom) {
                    gameState.creatingRoom = false;
                    gameState.creationTimeoutId = null;
                    gameState.lastActionError = 'Не удалось создать комнату. Сервер не ответил.';
                    renderApp();
                    alert('Сервер не ответил. Проверьте подключение и повторите попытку.');
                }
            }, 10000);
        }

        function joinRoom(roomId) { if (!gameState.wsConnected) { alert('Нет соединения с сервером'); return; } sendWS({ type: 'joinRoom', roomId }); }
        function joinRoomWithPassword(roomId) {
            if (!gameState.wsConnected) { alert('Нет соединения с сервером'); return; }
            const password = prompt('Введите пароль для входа в комнату:');
            if (password !== null) sendWS({ type: 'joinRoom', roomId, password });
        }

        function logout() {
            localStorage.removeItem('resistanceUser');
            gameState.user = null;
            gameState.rooms = [];
            gameState.currentRoom = null;
            gameState.gameData = null;
            try { gameState.ws?.close(); } catch {}
            gameState.ws = null; gameState.wsConnected = false;
            gameState.currentView = 'login';
            renderApp();
        }

        function renderGameRoomView() {
            const r = gameState.currentRoom;
            if (!r) { gameState.currentView = 'lobby'; renderApp(); return ''; }
            const isHost = r.hostId === gameState.user.id;
            const inviteLink = `${location.origin}${location.pathname}?room=${r.id}&invite=${r.inviteKey || ''}`;
            return `
                <div class="max-w-5xl mx-auto">
                    <div class="flex justify-between items-center mb-2">${connectionControlsInline()}</div>
                    <div class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-blue-400">Комната: ${r.name}</h1>
                            <p class="text-gray-300">Ожидание игроков... (${r.playersList.length}/${r.maxPlayers})</p>
                        </div>
                        <button onclick="leaveRoom()" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-semibold py-2 px-6 rounded-lg transition">
                            <i class="fas fa-times mr-2"></i>Покинуть комнату
                        </button>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg mb-6">
                                <h2 class="text-2xl font-bold text-yellow-400 mb-4">Игроки в комнате</h2>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                    ${r.playersList.map(p => `
                                        <div class="bg-gray-700 border ${p.id === gameState.user.id ? 'border-blue-500' : 'border-gray-600'} rounded-lg p-4 flex items-center">
                                            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold mr-3">${p.name.charAt(0)}</div>
                                            <div>
                                                <h3 class="font-semibold ${p.id === gameState.user.id ? 'text-blue-300' : 'text-white'}">${p.name}</h3>
                                                <p class="text-sm text-gray-400">${p.id === r.hostId ? 'Создатель комнаты' : 'Игрок'}</p>
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${Array.from({length: Math.max(0, r.maxPlayers - r.playersList.length)}).map(() => `
                                        <div class="bg-gray-800 border border-dashed border-gray-600 rounded-lg p-4 flex items-center">
                                            <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-gray-500 font-bold mr-3"><i class="fas fa-user-plus"></i></div>
                                            <div><h3 class="font-semibold text-gray-500">Ожидание игрока...</h3><p class="text-sm text-gray-500">Свободное место</p></div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>

                            <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                                <h2 class="text-2xl font-bold text-green-400 mb-4">Пригласить друзей</h2>
                                <div class="mb-4">
                                    <label class="block text-gray-300 mb-2">Ссылка для приглашения (без пароля)</label>
                                    <div class="flex">
                                        <input type="text" id="inviteLink" class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-l-lg" value="${inviteLink}" readonly>
                                        <button onclick="copyInviteLink()" class="bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 text-white font-semibold py-3 px-6 rounded-r-lg transition"><i class="fas fa-copy"></i></button>
                                    </div>
                                    <p class="text-sm text-gray-400 mt-2">По этой ссылке можно войти без пароля даже с другого устройства и IP</p>
                                </div>
                                ${r.hasPassword ? `
                                    <p class="text-sm text-gray-400">У комнаты также установлен пароль. По прямому входу через список потребуется пароль.</p>
                                ` : ''}
                            </div>
                        </div>

                        <div>
                            <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg sticky top-6">
                                <h2 class="text-2xl font-bold text-purple-400 mb-4">Управление игрой</h2>
                                <div class="mb-6">
                                    <div class="space-y-3">
                                        <div><p class="text-gray-400">Количество игроков:</p><p class="text-white font-bold">${r.maxPlayers}</p></div>
                                        <div><p class="text-gray-400">Шпионов в игре:</p><p class="text-white font-bold">${getSpyCount(r.maxPlayers)}</p></div>
                                        <div><p class="text-gray-400">Игроков сопротивления:</p><p class="text-white font-bold">${getResistanceCount(r.maxPlayers)}</p></div>
                                    </div>
                                </div>
                                ${isHost ? `
                                    <div class="mb-6">
                                        <h3 class="text-lg font-semibold text-gray-300 mb-2">Действия создателя</h3>
                                        <div class="space-y-3">
                                            <button onclick="startGame()" class="w-full bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 text-white font-semibold py-3 px-4 rounded-lg transition flex items-center justify-center">
                                                <i class="fas fa-play mr-2"></i>Начать игру
                                            </button>
                                            <p class="text-sm text-gray-400 text-center">Минимум 5 игроков. Роли распределит сервер.</p>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="mb-6">
                                        <div class="bg-blue-900/30 border border-blue-700 rounded-lg p-4">
                                            <div class="flex items-center">
                                                <i class="fas fa-hourglass-half text-blue-400 text-2xl mr-3"></i>
                                                <div>
                                                    <p class="text-white font-semibold">Ожидание создателя комнаты</p>
                                                    <p class="text-blue-300 text-sm">Игра начнется, когда создатель запустит её</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function copyInviteLink() { const el = byId('inviteLink'); el.select(); document.execCommand('copy'); alert('Ссылка скопирована!'); }
        function leaveRoom() { sendWS({ type: 'leaveRoom' }); gameState.currentRoom = null; gameState.currentView = 'lobby'; renderApp(); }
        function startGame() { sendWS({ type: 'startGame' }); }

        // --- Game Rendering (client uses server state) ---
        function renderGameView() {
            const game = gameState.gameData;
            if (!game) return '<div class="text-center py-12">Ожидание данных игры...</div>';
            const currentPlayer = game.players[game.currentPlayerIndex];
            const currentLeader = game.players.find(p => p.isLeader);
            const me = game.players.find(p => p.id === gameState.user.id) || {};
            const isSpy = me.role === 'spy';
            const isLeader = currentLeader?.id === gameState.user.id;

            let phaseContent = '';
            switch (game.phase) {
                case 'discussion': phaseContent = renderDiscussionPhase(game, currentPlayer, isLeader); break;
                case 'nomination': phaseContent = renderNominationPhase(game, currentPlayer, isLeader); break;
                case 'voting': phaseContent = renderVotingPhase(game, currentPlayer, isLeader); break;
                case 'leaderSelection': phaseContent = renderLeaderSelectionPhase(game, currentPlayer, isLeader); break;
                case 'missionTeamSelection': phaseContent = renderMissionTeamSelectionPhase(game, currentPlayer, isLeader); break;
                case 'missionVoting': phaseContent = renderMissionVotingPhase(game, currentPlayer, isLeader, isSpy); break;
                case 'missionResults': phaseContent = renderMissionResultsPhase(game, currentPlayer, isLeader); break;
                case 'tieDiscussion': phaseContent = renderTieDiscussionPhase(game); break;
                default: phaseContent = renderDiscussionPhase(game, currentPlayer, isLeader);
            }

            return `
                <div class="max-w-6xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-bold text-blue-400">Игра в Сопротивление</h1>
                            <p class="text-gray-300">Комната: ${gameState.currentRoom?.name || ''}</p>
                        </div>
                        <div class="flex items-center space-x-4 mt-4 md:mt-0">
                            <div class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2">
                                <p class="text-sm text-gray-400">Миссия</p>
                                <p class="text-xl font-bold text-yellow-400">${game.currentMission} / 5</p>
                            </div>
                            <div class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2">
                                <p class="text-sm text-gray-400">Успехов</p>
                                <p class="text-xl font-bold text-green-400">${game.successfulMissions}</p>
                            </div>
                            <div class="bg-gray-800 border border-gray-700 rounded-lg px-4 py-2">
                                <p class="text-sm text-gray-400">Провалов</p>
                                <p class="text-xl font-bold text-red-400">${game.failedMissions}</p>
                            </div>
                            <button onclick="returnToLobby()" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white font-semibold py-2 px-4 rounded-lg transition">
                                <i class="fas fa-times mr-2"></i>Выйти
                            </button>
                        </div>
                    </div>

                    <div class="mb-8">
                        <div class="bg-gradient-to-r from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full ${getPhaseColor(game.phase)} mr-3"></div>
                                    <h2 class="text-xl font-bold text-white">${getPhaseTitle(game.phase)}</h2>
                                </div>
                                <div class="text-lg font-bold ${getTimerColor(game)}">
                                    ${game.phase === 'discussion' ? game.discussionTimeLeft : game.phase === 'missionTeamSelection' ? game.nominationTimeLeft : '--'} сек
                                </div>
                            </div>
                            <p class="text-gray-300 mt-2">${getPhaseDescription(game.phase, game, currentPlayer)}</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">${phaseContent}</div>
                        <div>${renderGameSidebar(game, me, isSpy, isLeader)}</div>
                    </div>
                </div>
            `;
        }

        function getPhaseColor(phase){ switch(phase){case 'discussion':return 'bg-blue-500';case 'nomination':return 'bg-purple-500';case 'voting':return 'bg-yellow-500';case 'leaderSelection':return 'bg-indigo-500';case 'missionTeamSelection':return 'bg-green-500';case 'missionVoting':return 'bg-orange-500';case 'missionResults':return 'bg-red-500';case 'tieDiscussion':return 'bg-pink-500';default:return 'bg-gray-500';} }
        function getPhaseTitle(phase){ switch(phase){case 'discussion':return 'Обсуждение';case 'nomination':return 'Выдвижение кандидатов';case 'voting':return 'Голосование за лидера';case 'leaderSelection':return 'Выбор лидера';case 'missionTeamSelection':return 'Формирование команды миссии';case 'missionVoting':return 'Голосование за результат миссии';case 'missionResults':return 'Результаты миссии';case 'tieDiscussion':return 'Доп. обсуждение (ничья)';default:return 'Фаза';} }
        function getPhaseDescription(phase, game, currentPlayer){
            const playerName = currentPlayer?.name || 'игрок';
            if (phase==='discussion') return `Сейчас говорит ${playerName}. 40 секунд на обсуждение.`;
            if (phase==='missionTeamSelection') return 'Лидер выбирает состав миссии (80 секунд).';
            if (phase==='missionVoting') return 'Участники миссии тайно выбирают результат.';
            if (phase==='leaderSelection') return `${game.players.find(p=>p.isLeader)?.name || 'Лидер'} формирует команду.`;
            if (phase==='tieDiscussion') return 'Игроки с одинаковыми голосами обсуждают по 30 секунд. Затем перевыбор.';
            if (phase==='voting') return 'Голосование за лидера миссии.';
            if (phase==='missionResults') return 'Озвучивание результата миссии.';
            if (phase==='nomination') return 'Выдвижение кандидатов на лидера.';
            return '';
        }
        function getTimerColor(game){ let t=0; if(game.phase==='discussion')t=game.discussionTimeLeft; if(game.phase==='missionTeamSelection')t=game.nominationTimeLeft; if(t>20)return 'text-green-400'; if(t>10)return 'text-yellow-400'; return 'text-red-400'; }

        // --- Phase Renderers ---
        function renderDiscussionPhase(game, currentPlayer, isLeader){
            const isCurrentPlayer = currentPlayer?.id === gameState.user.id;
            return `
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg mb-6">
                    <h2 class="text-2xl font-bold text-blue-400 mb-6">Обсуждение</h2>
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-white">Сейчас говорит:</h3>
                            <div class="bg-blue-900/50 border border-blue-700 rounded-full px-4 py-1"><span class="text-blue-300 font-bold">${currentPlayer?.name || ''}</span></div>
                        </div>
                        <div class="bg-gray-900 rounded-lg p-4 mb-6">
                            <div class="flex items-center mb-4">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold mr-3">${(currentPlayer?.name || '?').charAt(0)}</div>
                                <div><h4 class="font-bold text-white">${currentPlayer?.name || ''}</h4><p class="text-sm text-gray-400">${isCurrentPlayer ? 'Вы' : 'Текущий выступающий'}</p></div>
                            </div>
                            ${isCurrentPlayer ? `
                                <div class="mb-4">
                                    <label class="block text-gray-300 mb-2">Ваше сообщение для обсуждения</label>
                                    <textarea id="discussionMessage" class="w-full h-32 px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none resize-none" placeholder="Выскажите свои мысли..."></textarea>
                                </div>
                                <button onclick="sendDiscussionMessage()" class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-semibold py-2 px-6 rounded-lg transition"><i class="fas fa-paper-plane mr-2"></i>Отправить</button>
                            ` : `<p class="text-gray-400 italic">Ожидание выступления ${currentPlayer?.name || ''}...</p>`}
                        </div>
                        <div class="flex justify-center">
                            <div class="bg-gray-900 rounded-lg p-4 w-full max-w-md">
                                <div class="flex justify-between items-center mb-2"><span class="text-gray-300">Время выступления:</span><span class="text-xl font-bold ${getTimerColor(game)}">${game.discussionTimeLeft} сек</span></div>
                                <div class="w-full bg-gray-700 rounded-full h-4"><div class="bg-gradient-to-r from-blue-500 to-indigo-600 h-4 rounded-full timer-bar" style="width:${(game.discussionTimeLeft/40)*100}%"></div></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-4">Очередь выступающих</h3>
                        <div class="flex flex-wrap gap-3">
                            ${game.players.map((p, idx)=>{
                                const isCurrent = idx===game.currentPlayerIndex;
                                return `<div class="flex flex-col items-center"><div class="w-12 h-12 rounded-full ${isCurrent?'bg-gradient-to-r from-blue-500 to-indigo-600 ring-4 ring-blue-400':'bg-gray-800 border border-gray-600'} flex items-center justify-center text-white font-bold mb-1">${isCurrent?'<i class=\'fas fa-microphone\'></i>':p.name.charAt(0)}</div><span class="text-sm ${isCurrent?'text-blue-300 font-bold':'text-gray-400'}">${p.name}</span></div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-purple-400 mb-4">Выдвижение кандидатов на лидера</h2>
                    <p class="text-gray-300 mb-6">Можно выдвинуть себя или другого игрока. У каждого игрока не более одного активного выдвижения.</p>
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-white mb-3">Выдвинутые кандидаты:</h3>
                        ${game.nominatedPlayers.length>0?`<div class="flex flex-wrap gap-3">${game.nominatedPlayers.map(n=>`<div class="bg-purple-900/30 border border-purple-700 rounded-full px-4 py-2 flex items-center"><i class="fas fa-user-check text-purple-400 mr-2"></i><span class="text-white font-semibold">${n}</span></div>`).join('')}</div>`:`<p class="text-gray-400 italic">Пока нет выдвинутых кандидатов</p>`}
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <button onclick="nominateSelf()" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-semibold py-3 px-4 rounded-lg"><i class="fas fa-user-plus mr-2"></i>Выдвинуть себя</button>
                        <button onclick="showNominationModal()" class="bg-gradient-to-r from-indigo-600 to-indigo-700 hover:from-indigo-700 hover:to-indigo-800 text-white font-semibold py-3 px-4 rounded-lg"><i class="fas fa-users mr-2"></i>Выдвинуть другого игрока</button>
                    </div>
                </div>
            `;
        }

        function renderNominationPhase(game){ return renderDiscussionPhase(game, game.players[game.currentPlayerIndex], false); }

        function renderVotingPhase(game){
            const me = game.players.find(p=>p.id===gameState.user.id) || {};
            const hasVoted = !!me.voted;
            return `
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-yellow-400 mb-6">Голосование за лидера миссии</h2>
                    ${hasVoted?`<div class="bg-yellow-900/30 border border-yellow-700 rounded-lg p-4 mb-6"><div class="flex items-center"><i class="fas fa-vote-yea text-yellow-400 text-2xl mr-3"></i><div><p class="text-white font-semibold">Вы уже проголосовали</p><p class="text-yellow-300 text-sm">Ожидаем остальных...</p></div></div></div>`:''}
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                        ${game.nominatedPlayers.map(name=>{
                            const isMe = (game.players.find(p=>p.name===name)?.id===gameState.user.id);
                            return `<div class="bg-gray-800 border ${isMe?'border-blue-500':'border-gray-700'} rounded-xl p-4 text-center"><div class="w-16 h-16 rounded-full bg-gradient-to-r from-yellow-500 to-orange-600 mx-auto flex items-center justify-center text-white font-bold text-xl mb-3">${name.charAt(0)}</div><h3 class="font-bold text-white text-lg mb-1">${name}</h3><p class="text-gray-400 text-sm mb-4">${isMe?'Вы':'Кандидат'}</p>${!hasVoted?`<button onclick="voteForLeader('${name}')" class="w-full bg-gradient-to-r from-yellow-600 to-orange-700 hover:from-yellow-700 hover:to-orange-800 text-white font-semibold py-2 px-4 rounded-lg"><i class="fas fa-check mr-2"></i>Выбрать</button>`:''}</div>`;
                        }).join('')}
                    </div>
                    <div class="text-center"><p class="text-gray-400">Проголосовали: ${Object.keys(game.votes).length} из ${game.players.length}</p></div>
                </div>
            `;
        }

        function renderLeaderSelectionPhase(game){
            const leader = game.players.find(p=>p.isLeader);
            const missionName = getMissionName(game.currentMission);
            const isLeader = leader?.id === gameState.user.id;
            return `
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-indigo-400 mb-6">Лидер миссии выбран!</h2>
                    <div class="flex flex-col items-center text-center mb-8">
                        <div class="w-24 h-24 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center text-white font-bold text-3xl mb-4">${leader?.name?.charAt(0) || 'Л'}</div>
                        <h3 class="font-bold text-white text-2xl mb-2">${leader?.name || 'Лидер'}</h3>
                        <p class="text-gray-300 text-lg">теперь лидер миссии №${game.currentMission}</p>
                    </div>
                    <div class="bg-indigo-900/30 border border-indigo-700 rounded-xl p-5 mb-8">
                        <div class="flex items-center mb-3"><i class="fas fa-bullseye text-indigo-400 text-xl mr-3"></i><h4 class="text-xl font-bold text-white">Миссия: ${missionName}</h4></div>
                        <p class="text-gray-300">Лидер должен выбрать ${game.missionSizes[game.currentMission - 1]} игрока(ов) для участия в миссии.</p>
                    </div>
                    <div class="text-center">
                        ${isLeader?`<button onclick="startMissionTeamSelection()" class="bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 text-white font-semibold py-3 px-8 rounded-lg text-lg"><i class="fas fa-play mr-2"></i>Начать формирование команды</button>`:`<p class="text-gray-300">Ожидание начала формирования команды...</p>`}
                    </div>
                </div>
            `;
        }

        function renderMissionTeamSelectionPhase(game){
            const leader = game.players.find(p=>p.isLeader);
            const missionSize = game.missionSizes[game.currentMission-1];
            const isLeader = leader?.id===gameState.user.id;
            const currentTeamSize = game.missionTeam.length;
            const isTeamFull = currentTeamSize >= missionSize;
            return `
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-green-400 mb-6">Формирование команды миссии</h2>
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <p class="text-gray-300">Лидер: <span class="font-bold text-white">${leader?.name || ''}</span></p>
                            <p class="text-gray-300">Размер команды: <span class="font-bold text-white">${missionSize} игрока(ов)</span></p>
                        </div>
                        <div class="bg-gray-900 rounded-lg p-3">
                            <div class="flex justify-between items-center mb-1"><span class="text-gray-300">Оставшееся время:</span><span class="text-xl font-bold ${getTimerColor(game)}">${game.nominationTimeLeft} сек</span></div>
                            <div class="w-64 bg-gray-700 rounded-full h-3"><div class="bg-gradient-to-r from-green-500 to-emerald-600 h-3 rounded-full timer-bar" style="width:${(game.nominationTimeLeft/80)*100}%"></div></div>
                        </div>
                    </div>
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-white mb-4">Выбранные игроки:</h3>
                        ${game.missionTeam.length>0?`<div class="flex flex-wrap gap-3 mb-4">${game.missionTeam.map(n=>`<div class="bg-green-900/30 border border-green-700 rounded-full px-4 py-2 flex items-center"><i class="fas fa-user-check text-green-400 mr-2"></i><span class="text-white font-semibold">${n}</span>${isLeader?`<button onclick=\"removeFromMissionTeam('${n}')\" class=\"ml-2 text-red-400 hover:text-red-300\"><i class='fas fa-times'></i></button>`:''}</div>`).join('')}</div><p class="text-gray-400">Выбрано: ${currentTeamSize} из ${missionSize}</p>`:`<p class="text-gray-400 italic">Команда еще не сформирована</p>`}
                    </div>
                    ${isLeader?`
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold text-white mb-4">Выберите игроков для миссии:</h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                ${game.players.map(p=>{
                                    const isInTeam = game.missionTeam.includes(p.name);
                                    const isSelf = p.id===gameState.user.id;
                                    return `<div class="bg-gray-800 border ${isInTeam?'border-green-500':'border-gray-700'} rounded-xl p-4 text-center"><div class="w-12 h-12 rounded-full ${isInTeam?'bg-gradient-to-r from-green-500 to-emerald-600':'bg-gradient-to-r from-blue-500 to-indigo-600'} mx-auto mb-3 flex items-center justify-center text-white font-bold">${p.name.charAt(0)}</div><h3 class="font-bold text-white mb-1">${p.name}</h3><p class="text-gray-400 text-sm mb-3">${isSelf?'Вы (лидер)':'Игрок'}</p><button onclick="${isInTeam?`removeFromMissionTeam('${p.name}')`:`addToMissionTeam('${p.name}')`}" class="w-full ${isInTeam?'bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800':'bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800'} text-white font-semibold py-2 px-4 rounded-lg" ${!isInTeam&&isTeamFull?'disabled':''}>${isInTeam?'<i class=\'fas fa-times mr-2\'></i>Убрать':'<i class=\'fas fa-plus mr-2\'></i>Добавить'}</button></div>`;
                                }).join('')}
                            </div>
                        </div>
                        <div class="flex justify-center space-x-4">
                            <button onclick="approveMissionTeam()" class="bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 text-white font-semibold py-3 px-8 rounded-lg text-lg" ${!isTeamFull?'disabled':''}><i class="fas fa-check-circle mr-2"></i>Утвердить состав</button>
                            <button onclick="resetMissionTeam()" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white font-semibold py-3 px-6 rounded-lg"><i class="fas fa-redo mr-2"></i>Сбросить</button>
                        </div>
                    `:`<div class="bg-gray-900 rounded-xl p-5"><div class="flex items-center"><i class="fas fa-hourglass-half text-green-400 text-2xl mr-3"></i><div><p class="text-white font-semibold">Ожидание формирования команды</p><p class="text-green-300">Лидер ${leader?.name || ''} выбирает игроков для миссии</p></div></div></div>`}
                </div>
            `;
        }

        function renderMissionVotingPhase(game, currentPlayer, isLeader, isSpy){
            const me = game.players.find(p=>p.id===gameState.user.id)||{};
            const hasVoted = me.missionVote!==null && me.missionVote!==undefined;
            const isInMission = game.missionTeam.includes(me.name||'');
            const btnPos=[{top:'20%',left:'30%'},{top:'60%',left:'70%'},{top:'40%',left:'10%'},{top:'80%',left:'50%'},{top:'30%',left:'80%'}];
            return `
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-orange-400 mb-6">Голосование за результат миссии</h2>
                    ${isInMission?`
                        ${hasVoted?`<div class=\"bg-orange-900/30 border border-orange-700 rounded-lg p-4 mb-6\"><div class=\"flex items-center\"><i class=\"fas fa-vote-yea text-orange-400 text-2xl mr-3\"></i><div><p class=\"text-white font-semibold\">Вы уже проголосовали</p><p class=\"text-orange-300 text-sm\">Ожидание остальных участников...</p></div></div></div>`:''}
                        <div class="relative h-96 bg-gray-900 rounded-xl overflow-hidden mb-8">
                            <div class="absolute inset-0 flex items-center justify-center"><div class="text-center"><h3 class="text-2xl font-bold text-white mb-2">Выберите результат</h3><p class="text-gray-300">Нажмите на одну из кнопок на экране</p></div></div>
                            ${Array.from({length:isSpy?1:2}).map((_,i)=>{const pos=btnPos[i%btnPos.length];return `<button onclick=\"voteForMission('success')\" class=\"absolute w-24 h-24 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold text-lg flex items-center justify-center shadow-lg transform hover:scale-110 transition-all\" style=\"top:${pos.top};left:${pos.left};\" ${hasVoted?'disabled':''}><div class=\"text-center\"><i class=\"fas fa-check text-2xl mb-1\"></i><div>Успех</div></div></button>`;}).join('')}
                            ${isSpy?`${Array.from({length:1}).map((_,i)=>{const pos=btnPos[2+i];return `<button onclick=\"voteForMission('fail')\" class=\"absolute w-24 h-24 rounded-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold text-lg flex items-center justify-center shadow-lg transform hover:scale-110 transition-all\" style=\"top:${pos.top};left:${pos.left};\" ${hasVoted?'disabled':''}><div class=\"text-center\"><i class=\"fas fa-times text-2xl mb-1\"></i><div>Провал</div></div></button>`;}).join('')}`:''}
                        </div>
                        <div class="text-center"><p class="text-gray-400">Проголосовали: ${Object.keys(game.missionVotes).length} из ${game.missionTeam.length}</p></div>
                    `:`<div class="bg-gray-900 rounded-xl p-5"><div class="flex items-center"><i class="fas fa-hourglass-half text-orange-400 text-2xl mr-3"></i><div><p class="text-white font-semibold">Вы не участвуете в этой миссии</p><p class="text-orange-300">Ожидание результатов голосования</p></div></div></div>`}
                </div>
            `;
        }

        function renderMissionResultsPhase(game){
            const last = game.missionResults[game.missionResults.length-1]||{};
            const missionName = getMissionName(game.currentMission-1);
            return `
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-red-400 mb-6">Результаты миссии №${game.currentMission-1}</h2>
                    <div class="flex flex-col items-center text-center mb-8">
                        <div class="w-32 h-32 rounded-full ${last.success?'bg-gradient-to-r from-green-500 to-emerald-600':'bg-gradient-to-r from-red-500 to-red-600'} flex items-center justify-center text-white font-bold text-4xl mb-4">${last.success?'<i class="fas fa-check"></i>':'<i class="fas fa-times"></i>'}</div>
                        <h3 class="font-bold text-white text-3xl mb-2">${last.success?'МИССИЯ УСПЕШНА!':'МИССИЯ ПРОВАЛЕНА!'}</h3>
                        <p class="text-gray-300 text-xl">${missionName}</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-gray-900 rounded-xl p-5"><h4 class="text-lg font-bold text-white mb-3">Результаты голосования:</h4><div class="space-y-3"><div class="flex justify-between items-center"><span class="text-gray-300">Голосов за успех:</span><span class="text-2xl font-bold text-green-400">${last.successCount||0}</span></div><div class="flex justify-between items-center"><span class="text-gray-300">Голосов за провал:</span><span class="text-2xl font-bold text-red-400">${last.failCount||0}</span></div><div class="pt-3 border-t border-gray-700"><p class="text-gray-300">${last.success?'Никто не голосовал за провал':'Кто-то проголосовал за провал'}</p></div></div></div>
                        <div class="bg-gray-900 rounded-xl p-5"><h4 class="text-lg font-bold text-white mb-3">Общий счёт игры:</h4><div class="space-y-3"><div class="flex justify-between items-center"><span class="text-gray-300">Успешных миссий:</span><span class="text-2xl font-bold text-green-400">${game.successfulMissions}</span></div><div class="flex justify-between items-center"><span class="text-gray-300">Проваленных миссий:</span><span class="text-2xl font-bold text-red-400">${game.failedMissions}</span></div><div class="pt-3 border-t border-gray-700"><p class="text-gray-300">Нужно 3 успешных или 3 провальных миссии для победы</p></div></div></div>
                    </div>
                    ${game.gameOver?`<div class="bg-gradient-to-r ${game.winner==='resistance'?'from-green-900/50 to-emerald-900/30 border-green-700':'from-red-900/50 to-red-900/30 border-red-700'} border rounded-xl p-5 mb-8 text-center"><h3 class="text-2xl font-bold text-white mb-2">ИГРА ОКОНЧЕНА!</h3><p class="text-xl ${game.winner==='resistance'?'text-green-400':'text-red-400'} font-bold mb-3">Победила команда ${game.winner==='resistance'?'СОПРОТИВЛЕНИЯ':'ШПИОНОВ'}!</p></div><div class="text-center"><button onclick="returnToLobby()" class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-semibold py-3 px-8 rounded-lg text-lg"><i class="fas fa-home mr-2"></i>Вернуться в лобби</button></div>`:`<div class="text-center"><button onclick="startNextMission()" class="bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-semibold py-3 px-8 rounded-lg text-lg"><i class="fas fa-forward mr-2"></i>Перейти к следующей миссии</button></div>`}
                </div>
            `;
        }

        function renderTieDiscussionPhase(game){
            return `
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-pink-400 mb-6">Ничья на голосовании</h2>
                    <p class="text-gray-300 mb-4">Игроки: ${(game.tieCandidates||[]).join(', ')} поочередно получают по 30 секунд для обсуждения. После этого будет повторное голосование.</p>
                    <div class="text-center"><button onclick="tieRevote()" class="bg-gradient-to-r from-yellow-600 to-orange-700 hover:from-yellow-700 hover:to-orange-800 text-white font-semibold py-2 px-6 rounded-lg"><i class="fas fa-undo mr-2"></i>Начать перевыбор</button></div>
                </div>
            `;
        }

        function renderGameSidebar(game, me, isSpy, isLeader){
            const spyPlayers = isSpy ? (gameState.spiesList || []) : [];
            const userSpyNumber = me.spyNumber;
            return `
                <div class="space-y-6">
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                        <h2 class="text-xl font-bold text-white mb-4">Ваша роль</h2>
                        <div class="role-card ${isSpy?'flipped':''}" onclick="toggleRoleCard()">
                            <div class="role-card-inner">
                                <div class="role-card-front flex items-center justify-center p-6 text-center">
                                    <div>
                                        <div class="w-20 h-20 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 flex items-center justify-center text-white font-bold text-2xl mb-4"><i class="fas fa-users"></i></div>
                                        <h3 class="text-2xl font-bold text-green-400 mb-2">Сопротивление</h3>
                                        <p class="text-gray-300">Выполните 3 миссии успешно</p>
                                        <p class="text-gray-400 text-sm mt-4"><i class="fas fa-sync-alt mr-1"></i>Нажмите, чтобы раскрыть роль</p>
                                    </div>
                                </div>
                                <div class="role-card-back flex items-center justify-center p-6 text-center">
                                    <div>
                                        <div class="w-20 h-20 rounded-full bg-gradient-to-r from-red-500 to-red-600 flex items-center justify-center text-white font-bold text-2xl mb-4"><i class="fas fa-user-secret"></i></div>
                                        <h3 class="text-2xl font-bold text-red-400 mb-2">Шпион №${userSpyNumber || '?'}</h3>
                                        <p class="text-gray-300">Провалите 3 миссии</p>
                                        ${spyPlayers.length>1?`<div class="mt-4 pt-4 border-t border-gray-700 w-full"><h4 class="text-white font-semibold mb-2">Другие шпионы:</h4>${spyPlayers.filter(s=>s.id!==me.id).map(s=>`<div class=\"flex items-center mb-2\"><div class=\"w-8 h-8 rounded-full bg-red-700 flex items-center justify-center text-white text-sm font-bold mr-2\">${s.spyNumber}</div><span class=\"text-white\">${s.name}</span></div>`).join('')}</div>`:`<p class="text-gray-400 text-sm mt-4">Вы единственный шпион</p>`}
                                        <p class="text-gray-400 text-sm mt-4"><i class="fas fa-sync-alt mr-1"></i>Нажмите, чтобы скрыть роль</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                        <h2 class="text-xl font-bold text-white mb-4">Информация о миссиях</h2>
                        <div class="space-y-4">
                            <div><h3 class="text-gray-300 mb-1">Текущая миссия:</h3><p class="text-white font-bold text-lg">${getMissionName(game.currentMission)}</p></div>
                            <div><h3 class="text-gray-300 mb-1">Размер команды:</h3><p class="text-white font-bold text-lg">${game.missionSizes[game.currentMission-1]} игрока</p></div>
                            <div><h3 class="text-gray-300 mb-1">Особые правила:</h3><p class="text-sm text-gray-400">${game.currentMission===3 && [7,8,9].includes(game.players.length)?'Для провала нужно 2 голоса за провал':'Достаточно 1 голоса за провал'}</p></div>
                        </div>
                        <div class="mt-6 pt-6 border-t border-gray-700">
                            ${game.missionSizes.map((size,idx)=>{const m=idx+1;const isCur=m===game.currentMission;const res=game.missionResults[idx];return `<div class=\"flex items-center justify-between ${isCur?'bg-blue-900/30 p-2 rounded':''}\"><div class=\"flex items-center\"><div class=\"w-8 h-8 rounded-full ${isCur?'bg-blue-600':res?(res.success?'bg-green-600':'bg-red-600'):'bg-gray-700'} flex items-center justify-center text-white text-sm font-bold mr-3\">${m}</div><span class=\"${isCur?'text-blue-300 font-bold':'text-gray-300'}\">Миссия ${m}: ${size} игроков</span></div>${res?`<span class=\"text-sm ${res.success?'text-green-400':'text-red-400'}\">${res.success?'✓':'✗'}</span>`:''}</div>`;}).join('')}
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-gray-800 to-gray-900 border border-gray-700 rounded-xl p-6 shadow-lg">
                        <h2 class="text-xl font-bold text-white mb-4">Игроки</h2>
                        <div class="space-y-3">
                            ${game.players.map(p=>{const isMe=p.id===gameState.user.id;const isLead=p.isLeader;const inTeam=(game.missionTeam||[]).includes(p.name);const isNom=(game.nominatedPlayers||[]).includes(p.name);return `<div class=\"flex items-center justify-between ${isMe?'bg-blue-900/30 p-2 rounded':''}\"><div class=\"flex items-center\"><div class=\"w-10 h-10 rounded-full ${isLead?'bg-gradient-to-r from-yellow-500 to-orange-600':isMe?'bg-gradient-to-r from-blue-500 to-indigo-600':'bg-gray-700'} flex items-center justify-center text-white font-bold mr-3\">${p.name.charAt(0)}</div><div><h3 class=\"font-semibold ${isMe?'text-blue-300':'text-white'}\">${p.name}</h3><p class=\"text-xs text-gray-400\">${isLead?'Лидер':isMe?'Вы':'Игрок'}${inTeam?' • В миссии':''}${isNom?' • Кандидат':''}</p></div></div>${isSpy && p.id!==gameState.user.id && (gameState.spiesList||[]).some(s=>s.id===p.id)?`<div class=\"w-6 h-6 rounded-full bg-red-600 flex items-center justify-center text-white text-xs font-bold\">${(gameState.spiesList.find(s=>s.id===p.id)||{}).spyNumber||''}</div>`:''}</div>`;}).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function getMissionName(n){const names=["Операция 'Рассвет'","Операция 'Тишина'","Операция 'Обман'","Операция 'Восход'","Операция 'Феникс'"];return names[n-1]||`Миссия ${n}`}
        function toggleRoleCard(){const el=document.querySelector('.role-card'); if(el) el.classList.toggle('flipped');}

        // --- Client actions -> server
        function sendDiscussionMessage(){ const msg = byId('discussionMessage')?.value?.trim(); if(!msg) return; sendAction('sendDiscussionMessage',{message:msg}); alert('Сообщение отправлено'); }
        function nominateSelf(){ sendAction('nominateSelf'); }
        function showNominationModal(){ const game=gameState.gameData; if(!game)return; const others=game.players.filter(p=>p.id!==gameState.user.id && !(game.nominatedPlayers||[]).includes(p.name)); if(others.length===0){alert('Нет доступных игроков для выдвижения');return;} const name=prompt('Введите имя игрока из списка: '+others.map(p=>p.name).join(', '), others[0].name); if(name && others.some(p=>p.name===name)){ sendAction('nominateOther',{playerName:name}); } }
        function removeNomination(name){ sendAction('removeNomination',{playerName:name}); }
        function endNominationPhase(){ sendAction('endNominationPhase'); }
        function voteForLeader(name){ sendAction('voteForLeader',{playerName:name}); }
        function startMissionTeamSelection(){ sendAction('startMissionTeamSelection'); }
        function addToMissionTeam(name){ sendAction('addToMissionTeam',{playerName:name}); }
        function removeFromMissionTeam(name){ sendAction('removeFromMissionTeam',{playerName:name}); }
        function resetMissionTeam(){ sendAction('resetMissionTeam'); }
        function approveMissionTeam(){ sendAction('approveMissionTeam'); }
        function voteForMission(vote){ sendAction('voteForMission',{vote}); }
        function startNextMission(){ sendAction('startNextMission'); }
        function tieRevote(){ sendAction('tieRevote'); }
        function returnToLobby(){ gameState.currentRoom=null; gameState.gameData=null; gameState.currentView='lobby'; renderApp(); }

        // Connection utilities
        function promptServerUrl(){
            const current = wsUrl();
            const input = prompt('Укажите адрес WebSocket сервера (ws:// или wss://):', current);
            if (input && typeof input === 'string') {
                const trimmed = input.trim();
                localStorage.setItem('resistanceServerWsUrl', trimmed);
                gameState.serverWsUrl = trimmed;
                connectWS();
                renderApp();
            }
        }
        function reconnectNow(){ connectWS(); }
        
        function showHelp() {
            alert(`ПОШАГОВАЯ ИНСТРУКЦИЯ ПО ЗАПУСКУ:

1. ДЛЯ ЛОКАЛЬНОГО ТЕСТИРОВАНИЯ:
   - Установите Node.js с сайта nodejs.org (версия 14 или выше)
   - Откройте терминал в папке с игрой
   - Выполните команды:
     npm install
     npm start
   - После запуска сервера откройте браузер по адресу:
     http://localhost:8080

2. ДЛЯ ИГРЫ С ДРУЗЬЯМИ ЧЕРЕЗ ИНТЕРНЕТ:
   - Используйте публичный сервер: wss://test-pul.onrender.com
   - Откройте файл index.html на любом хостинге (GitHub Pages, Netlify и т.д.)
   - Нажмите кнопку "Настройки" и введите адрес сервера
   - ИЛИ добавьте параметр в URL:
     ?server=wss://test-pul.onrender.com

3. ПРИ ОТКРЫТИИ С GITHUB PAGES:
   - Адрес сервера автоматически установится на wss://test-pul.onrender.com
   - Просто создайте комнату и пригласите друзей по ссылке

4. ЕСЛИ СЕРВЕР НЕ ЗАПУСКАЕТСЯ:
   - Проверьте, что порт 8080 не занят: PORT=8081 npm start
   - Проверьте брандмауэр и разрешите подключения
   - Убедитесь, что зависимости установлены: npm install

Подробная инструкция в файле README.md`);
        }

        // --- Utils ---
        function getSpyCount(pc){ pc=parseInt(pc); if(pc===5) return 2; if(pc===6) return 2; if(pc===7) return 3; if(pc===8) return 3; if(pc===9) return 3; return 2; }
        function getResistanceCount(pc){ return pc - getSpyCount(pc); }

        // Password field toggle
        document.addEventListener('change', (e)=>{
            if (e.target && e.target.id==='usePassword') {
                const pf = byId('roomPassword'); if (!pf) return;
                if (e.target.checked) { pf.classList.remove('hidden'); pf.focus(); } else { pf.classList.add('hidden'); }
            }
        });
    </script>
</body>
</html>