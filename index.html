
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сопротивление - Мультиплеерная игра</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .timer-bar { transition: width 1s linear; }
        .role-card { perspective: 1000px; }
        .role-card-inner { transition: transform 0.8s; transform-style: preserve-3d; position: relative; width: 100%; height: 260px; }
        .role-card-front, .role-card-back { backface-visibility: hidden; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 0.75rem; }
        .role-card-back { transform: rotateY(180deg); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        .animate-bounce-slow { animation: bounce 2s infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 to-gray-800 text-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl"></div>

    <script>
        // --- Global State ---
        const gameState = {
            currentView: 'login', // login, lobby, game-room, game
            user: null,
            rooms: [],
            currentRoom: null, // {id, name, host, hostId, maxPlayers, hasPassword, inviteKey, playersList: []}
            gameData: null,    // server-synced game object (masked for others)
            spiesList: [],     // only for current spy
            ws: null,
            wsConnected: false,
            pendingInvite: null, // {roomId, inviteKey}
            // connection mgmt
            serverWsUrl: null,
            reconnectAttempts: 0,
            reconnectTimerId: null,
            connectionTimeoutId: null,
            connecting: false,
            lastError: null,
            creatingRoom: false,
            lastActionError: null,
            creationTimeoutId: null,
            showCreateRoomForm: false, // UI state
            isRoleFlipped: false
        };

        // --- Helpers ---
        const byId = (id) => document.getElementById(id);

        const computeDefaultWsUrl = () => {
            const params = new URLSearchParams(location.search);
            const serverParam = params.get('server');
            if (serverParam) {
                let url = serverParam.trim();
                if (url.startsWith('https://')) return url.replace('https://', 'wss://');
                if (url.startsWith('http://')) return url.replace('http://', 'ws://');
                if (url.startsWith('ws://') || url.startsWith('wss://')) return url;
                return 'wss://' + url;
            }
            return 'ws://localhost:8080';
        };
        const wsUrl = () => gameState.serverWsUrl || localStorage.getItem('resistanceServerWsUrl') || computeDefaultWsUrl();

        const generateDeviceId = () => {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now().toString(36);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        };
        const sendWS = (payload) => {
            if (gameState.ws && gameState.ws.readyState === WebSocket.OPEN) {
                try {
                    gameState.ws.send(JSON.stringify(payload));
                    console.log('Отправлено сообщение:', payload.type, payload);
                } catch (e) {
                    console.error('Ошибка отправки сообщения:', e);
                    gameState.lastError = 'Ошибка отправки данных. Соединение может быть разорвано.';
                    renderApp();
                }
            } else {
                console.error('WebSocket не подключен, состояние:', gameState.ws?.readyState);
                gameState.lastError = 'Соединение с сервером отсутствует.';
                renderApp();
            }
        };
        const sendAction = (name, extra = {}) => sendWS({ type: 'action', action: { name, ...extra } });

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            gameState.serverWsUrl = localStorage.getItem('resistanceServerWsUrl') || computeDefaultWsUrl();

            const savedUser = localStorage.getItem('resistanceUser');
            const params = new URLSearchParams(location.search);
            const inviteRoom = params.get('room');
            const inviteKey = params.get('invite');

            if (savedUser) {
                gameState.user = JSON.parse(savedUser);
            }
            
            gameState.currentView = 'login';
            renderApp();
            
            connectWS();

            if (inviteRoom && inviteKey) {
                gameState.pendingInvite = { roomId: inviteRoom, inviteKey };
            }
        });

        function connectWS() {
            try { if (gameState.ws) { try { gameState.ws.close(); } catch {} } } catch {}
            if (gameState.reconnectTimerId) { clearTimeout(gameState.reconnectTimerId); gameState.reconnectTimerId = null; }
            if (gameState.connectionTimeoutId) { clearTimeout(gameState.connectionTimeoutId); gameState.connectionTimeoutId = null; }
            if (gameState.creationTimeoutId) { clearTimeout(gameState.creationTimeoutId); gameState.creationTimeoutId = null; }

            let url = wsUrl();
            console.log('Попытка подключения к WebSocket:', url);
            gameState.connecting = true;
            gameState.wsConnected = false;
            gameState.lastError = null;
            gameState.creatingRoom = false;
            gameState.lastActionError = null;
            renderApp();
            
            try {
                gameState.ws = new WebSocket(url);
            } catch (e) {
                console.error('Ошибка создания WebSocket:', e.message);
                gameState.wsConnected = false;
                gameState.connecting = false;
                gameState.lastError = `Ошибка создания WebSocket: ${e.message}`;
                scheduleReconnect();
                renderApp();
                return;
            }

            gameState.connectionTimeoutId = setTimeout(() => {
                if (!gameState.wsConnected && gameState.connecting) {
                    console.error('Таймаут подключения WebSocket');
                    gameState.ws.close();
                    gameState.wsConnected = false;
                    gameState.connecting = false;
                    gameState.lastError = 'Таймаут подключения. Сервер не отвечает.';
                    scheduleReconnect();
                    renderApp();
                }
            }, 10000);

            gameState.ws.onopen = () => {
                console.log('WebSocket подключение установлено');
                if (gameState.connectionTimeoutId) {
                    clearTimeout(gameState.connectionTimeoutId);
                    gameState.connectionTimeoutId = null;
                }
                gameState.wsConnected = true;
                gameState.connecting = false;
                gameState.lastError = null;
                gameState.reconnectAttempts = 0;
                if (gameState.reconnectTimerId) { 
                    clearTimeout(gameState.reconnectTimerId); 
                    gameState.reconnectTimerId = null; 
                }
                if (gameState.user) {
                    sendWS({ type: 'hello', userId: gameState.user.id, name: gameState.user.name });
                    sendWS({ type: 'getLobby' });
                    if (gameState.pendingInvite) {
                        const { roomId, inviteKey } = gameState.pendingInvite;
                        sendWS({ type: 'joinRoom', roomId, inviteKey });
                        gameState.pendingInvite = null;
                    }
                } else {
                    sendWS({ type: 'getLobby' });
                }
                renderApp();
            };
            gameState.ws.onmessage = (e) => handleServerMessage(e.data);
            gameState.ws.onclose = () => { 
                console.log('WebSocket соединение закрыто');
                if (gameState.connectionTimeoutId) {
                    clearTimeout(gameState.connectionTimeoutId);
                    gameState.connectionTimeoutId = null;
                }
                gameState.wsConnected = false; 
                gameState.connecting = false;
                renderApp(); 
                scheduleReconnect(); 
            };
            gameState.ws.onerror = (err) => { 
                console.error('WebSocket ошибка:', err); 
                if (gameState.connectionTimeoutId) {
                    clearTimeout(gameState.connectionTimeoutId);
                    gameState.connectionTimeoutId = null;
                }
                gameState.wsConnected = false; 
                gameState.connecting = false;
                gameState.lastError = 'Не удалось подключиться к серверу.';
                renderApp(); 
            };
        }

        function scheduleReconnect() {
            const attempt = Math.min(gameState.reconnectAttempts + 1, 10);
            gameState.reconnectAttempts = attempt;
            const delay = Math.min(30000, Math.pow(2, attempt - 1) * 1000); 
            if (gameState.reconnectTimerId) return;
            gameState.reconnectTimerId = setTimeout(() => {
                gameState.reconnectTimerId = null;
                connectWS();
            }, delay);
        }

        function handleServerMessage(raw) {
            let data; try { data = JSON.parse(raw); } catch { return; }
            console.log('Получено от сервера:', data.type, data);
            
            if (data.type === 'lobby') {
                gameState.rooms = (data.rooms || []).map(r => ({
                    id: r.id, name: r.name, host: r.host, hostId: r.hostId,
                    players: r.players, maxPlayers: r.maxPlayers,
                    hasPassword: !!r.hasPassword
                }));
                renderApp();
                return;
            }
            if (data.type === 'room') {
                const r = data.room || {};
                gameState.currentRoom = {
                    id: r.id, name: r.name, host: r.host, hostId: r.hostId,
                    maxPlayers: r.maxPlayers, hasPassword: !!r.hasPassword,
                    inviteKey: r.inviteKey || null,
                    playersList: (data.players || []).map(p => ({ id: p.id, name: p.name }))
                };
                gameState.creatingRoom = false;
                gameState.lastActionError = null;
                if (gameState.creationTimeoutId) {
                    clearTimeout(gameState.creationTimeoutId);
                    gameState.creationTimeoutId = null;
                }
                if (gameState.currentView !== 'game') gameState.currentView = 'game-room';
                renderApp();
                return;
            }
            if (data.type === 'game') {
                gameState.gameData = data.game || null;
                gameState.spiesList = data.spies || [];
                gameState.creatingRoom = false;
                gameState.lastActionError = null;
                if (gameState.currentView !== 'game') gameState.currentView = 'game';
                renderApp();
                return;
            }
            if (data.type === 'error') {
                gameState.creatingRoom = false;
                gameState.lastActionError = data.message || 'Ошибка';
                if (gameState.creationTimeoutId) {
                    clearTimeout(gameState.creationTimeoutId);
                    gameState.creationTimeoutId = null;
                }
                alert(data.message || 'Ошибка');
                renderApp();
                return;
            }
        }

        // --- Render Root ---
        function renderApp() {
            const app = byId('app');
            if (!app) return;
            switch (gameState.currentView) {
                case 'login': app.innerHTML = renderLoginView(); break;
                case 'lobby': app.innerHTML = renderLobbyView(); break;
                case 'game-room': app.innerHTML = renderGameRoomView(); break;
                case 'game': app.innerHTML = renderGameView(); break;
                default: app.innerHTML = '<div>Загрузка...</div>';
            }
        }

        function connectionControlsInline() {
            const connected = gameState.wsConnected;
            const connecting = gameState.connecting;
            const url = wsUrl();
            let statusText = '';
            let statusClass = '';
            let statusIcon = '';
            
            if (connecting) {
                statusText = 'Подключение...';
                statusClass = 'bg-yellow-700 text-yellow-200';
                statusIcon = 'fa-spinner fa-spin';
            } else if (connected) {
                statusText = 'Подключено';
                statusClass = 'bg-green-700 text-green-200';
                statusIcon = 'fa-circle-check';
            } else {
                statusText = 'Нет соединения';
                statusClass = 'bg-red-700 text-red-200';
                statusIcon = 'fa-circle-xmark';
            }
            
            return `
                <div class="flex flex-wrap items-center gap-2">
                    <span class="inline-flex items-center text-xs px-2 py-1 rounded-full ${statusClass}">
                        <i class="fas ${statusIcon} mr-1"></i>${statusText}
                    </span>
                    <span class="text-xs text-gray-400 truncate max-w-[200px]" title="${url}"><i class="fas fa-plug mr-1"></i>${url}</span>
                    <button onclick="reconnectNow()" class="text-xs bg-gray-700 hover:bg-gray-600 border border-gray-600 px-2 py-1 rounded"><i class="fas fa-rotate mr-1"></i>Подключиться</button>
                    <button onclick="promptServerUrl()" class="text-xs bg-gray-700 hover:bg-gray-600 border border-gray-600 px-2 py-1 rounded"><i class="fas fa-gear mr-1"></i>Настройки</button>
                </div>
            `;
        }

        // --- Views ---
        function renderLoginView() {
            const savedName = gameState.user?.name || '';
            return `
                <div class="max-w-md mx-auto bg-gray-800 rounded-xl shadow-2xl p-8 mt-12">
                    <div class="flex items-start justify-between mb-4">
                        <div class="text-left">
                            <h1 class="text-4xl font-bold text-blue-400 mb-2">Сопротивление</h1>
                            <p class="text-gray-300">Мультиплеерная игра</p>
                        </div>
                    </div>
                    ${connectionControlsInline()}
                    <div class="mb-6 mt-4">
                        <label class="block text-gray-300 mb-2" for="username">Имя игрока</label>
                        <input type="text" id="username" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Введите ваше имя" value="${savedName}">
                    </div>
                    <div class="mb-8">
                        <label class="block text-gray-300 mb-2" for="deviceId">ID устройства</label>
                        <input type="text" id="deviceId" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg" value="${generateDeviceId()}" readonly>
                    </div>
                    <button onclick="handleLogin()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-semibold py-3 px-4 rounded-lg transition ${!gameState.wsConnected ? 'opacity-50' : ''}">
                        <i class="fas fa-sign-in-alt mr-2"></i>Войти в игру
                    </button>
                    <div class="mt-6 pt-6 border-t border-gray-700 text-center">
                        <p class="text-gray-400 text-sm"><a href="javascript:void(0);" onclick="showHelp()" class="text-blue-400 hover:text-blue-300 underline">Инструкция по запуску</a></p>
                    </div>
                </div>
            `;
        }

        function handleLogin() {
            const username = byId('username')?.value?.trim();
            const deviceId = byId('deviceId')?.value;
            if (!username) { alert('Пожалуйста, введите имя игрока'); return; }
            if (!gameState.wsConnected) { alert('Дождитесь подключения к серверу'); return; }
            gameState.user = { id: deviceId, name: username, deviceId };
            localStorage.setItem('resistanceUser', JSON.stringify(gameState.user));
            gameState.currentView = 'lobby';
            sendWS({ type: 'hello', userId: gameState.user.id, name: gameState.user.name });
            sendWS({ type: 'getLobby' });
            if (gameState.pendingInvite) {
                const { roomId, inviteKey } = gameState.pendingInvite;
                sendWS({ type: 'joinRoom', roomId, inviteKey });
                gameState.pendingInvite = null;
            }
            renderApp();
        }

        function renderLobbyView() {
            return `
                <div class="mb-8">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                        <div class="w-full md:w-auto">
                            <h1 class="text-3xl font-bold text-blue-400">Лобби игры</h1>
                            <div class="flex items-center gap-2">
                                <p class="text-gray-300">Игрок: <span class="font-bold text-white">${gameState.user?.name || ''}</span></p>
                                <button onclick="changeNickname()" class="text-xs bg-gray-700 px-2 py-1 rounded"><i class="fas fa-edit"></i></button>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row items-center gap-3 mt-4 md:mt-0">
                            ${connectionControlsInline()}
                            <button onclick="showCreateRoomForm()" class="bg-gradient-to-r from-green-600 to-emerald-700 text-white font-semibold py-2 px-6 rounded-lg">Создать комнату</button>
                            <button onclick="logout()" class="bg-gray-700 text-white font-semibold py-2 px-6 rounded-lg">Выйти</button>
                        </div>
                    </div>

                    ${gameState.showCreateRoomForm ? `
                    <div id="createRoomCard" class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-green-400">Создать игру</h3>
                            <button onclick="hideCreateRoomForm()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                        </div>
                        ${!gameState.wsConnected ? `<p class="text-red-400 mb-2">Нет соединения с сервером</p>` : ''}
                        ${gameState.creatingRoom ? `<p class="text-yellow-400 mb-2"><i class="fas fa-spinner fa-spin mr-2"></i>Создание комнаты...</p>` : ''}
                        <div class="mb-4">
                            <label class="block text-gray-300 mb-2">Игроков</label>
                            <select id="playerCount" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg">
                                <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8" selected>8</option><option value="9">9</option>
                            </select>
                        </div>
                        <div class="mb-6">
                            <label class="flex items-center text-gray-300"><input type="checkbox" id="usePassword" class="mr-2" onchange="togglePasswordInput(this)">Пароль</label>
                            <input type="password" id="roomPassword" class="w-full mt-2 px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg hidden" placeholder="Пароль">
                        </div>
                        <button onclick="createRoomFromForm()" ${gameState.creatingRoom ? 'disabled' : ''} class="w-full bg-green-600 text-white font-semibold py-3 px-4 rounded-lg">Создать</button>
                    </div>` : ''}

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${gameState.rooms.map(room => `
                            <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-xl font-bold text-blue-400">${room.name}</h3><p class="text-gray-300">Хост: ${room.host}</p></div>
                                    <div class="bg-gray-700 text-white text-sm font-semibold px-3 py-1 rounded-full">${room.players}/${room.maxPlayers}</div>
                                </div>
                                <div class="mb-6"><div class="flex items-center text-gray-300 mb-2"><i class="fas ${room.hasPassword ? 'fa-lock text-red-400' : 'fa-lock-open text-green-400'} mr-2"></i>${room.hasPassword ? 'Пароль' : 'Открыта'}</div></div>
                                <div class="flex space-x-3">
                                    ${room.hasPassword ? `<button onclick="joinRoomWithPassword('${room.id}')" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg">Войти</button>` : `<button onclick="joinRoom('${room.id}')" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg">Войти</button>`}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function showCreateRoomForm() { gameState.showCreateRoomForm = true; renderApp(); }
        function hideCreateRoomForm() { gameState.showCreateRoomForm = false; renderApp(); }
        function togglePasswordInput(cb) { const el = byId('roomPassword'); if (el) el.classList.toggle('hidden', !cb.checked); }
        function createRoomFromForm() {
            if (!gameState.wsConnected) { alert('Нет соединения'); return; }
            const pc = parseInt(byId('playerCount').value);
            const pass = byId('usePassword').checked ? byId('roomPassword').value : null;
            gameState.creatingRoom = true;
            renderApp();
            sendWS({ type: 'createRoom', name: `Игра ${gameState.user.name}`, maxPlayers: pc, password: pass });
            gameState.creationTimeoutId = setTimeout(() => { gameState.creatingRoom = false; gameState.lastActionError='Timeout'; renderApp(); }, 10000);
        }
        function joinRoom(id) { sendWS({ type: 'joinRoom', roomId: id }); }
        function joinRoomWithPassword(id) { const p = prompt('Пароль:'); if (p!==null) sendWS({ type: 'joinRoom', roomId: id, password: p }); }
        function logout() { localStorage.removeItem('resistanceUser'); gameState.user=null; gameState.currentView='login'; renderApp(); }
        function changeNickname() { const n = prompt('Новое имя:', gameState.user.name); if(n) { gameState.user.name=n; localStorage.setItem('resistanceUser', JSON.stringify(gameState.user)); sendWS({type:'hello', userId:gameState.user.id, name:n}); renderApp(); } }

        function renderGameRoomView() {
            const r = gameState.currentRoom;
            if (!r) { gameState.currentView = 'lobby'; renderApp(); return ''; }
            const isHost = r.hostId === gameState.user.id;
            const inviteLink = `${location.origin}${location.pathname}?room=${r.id}&invite=${r.inviteKey || ''}`;
            return `
                <div class="max-w-5xl mx-auto">
                    <div class="flex justify-between items-center mb-2">${connectionControlsInline()}</div>
                    <div class="flex justify-between items-center mb-8">
                        <div><h1 class="text-3xl font-bold text-blue-400">Комната: ${r.name}</h1><p class="text-gray-300">(${r.playersList.length}/${r.maxPlayers})</p></div>
                        <button onclick="leaveRoom()" class="bg-red-600 text-white py-2 px-6 rounded-lg">Покинуть</button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg mb-6">
                                <h2 class="text-2xl font-bold text-yellow-400 mb-4">Игроки</h2>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                                    ${r.playersList.map(p => `<div class="bg-gray-700 border border-gray-600 rounded-lg p-4 flex items-center"><div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold mr-3">${p.name.charAt(0)}</div><div><h3 class="font-semibold text-white">${p.name}</h3></div></div>`).join('')}
                                </div>
                            </div>
                            <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
                                <h2 class="text-2xl font-bold text-green-400 mb-4">Пригласить</h2>
                                <div class="flex"><input type="text" id="inviteLink" class="flex-1 px-4 py-3 bg-gray-700 border border-gray-600 rounded-l-lg" value="${inviteLink}" readonly><button onclick="copyInviteLink()" class="bg-green-600 text-white px-6 rounded-r-lg"><i class="fas fa-copy"></i></button></div>
                            </div>
                        </div>
                        <div>
                            <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg sticky top-6">
                                <h2 class="text-2xl font-bold text-purple-400 mb-4">Инфо</h2>
                                <div class="space-y-3 mb-6">
                                    <div><p class="text-gray-400">Шпионов:</p><p class="text-white font-bold">${getSpyCount(r.maxPlayers)}</p></div>
                                    <div><p class="text-gray-400">Сопротивления:</p><p class="text-white font-bold">${getResistanceCount(r.maxPlayers)}</p></div>
                                </div>
                                ${isHost ? `<button onclick="startGame()" class="w-full bg-green-600 text-white py-3 rounded-lg">Начать игру</button>` : `<p class="text-center text-gray-400">Ожидание хоста...</p>`}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        function copyInviteLink() { const el=byId('inviteLink'); el.select(); document.execCommand('copy'); alert('Скопировано'); }
        function leaveRoom() { sendWS({ type: 'leaveRoom' }); gameState.currentRoom=null; gameState.currentView='lobby'; renderApp(); }
        function startGame() { sendWS({ type: 'startGame' }); }

        function renderGameView() {
            const game = gameState.gameData;
            if (!game) return '<div>Loading...</div>';
            
            // New Phase Handler
            if (game.phase === 'roleReveal') return renderRoleRevealPhase(game);

            const currentPlayer = game.players[game.currentPlayerIndex];
            const currentLeader = game.players.find(p => p.isLeader);
            const me = game.players.find(p => p.id === gameState.user.id) || {};
            const isSpy = me.role === 'spy';
            const isLeader = currentLeader?.id === gameState.user.id;

            let phaseContent = '';
            switch (game.phase) {
                case 'discussion': phaseContent = renderDiscussionPhase(game, currentPlayer, isLeader); break;
                case 'leaderDiscussion': phaseContent = renderDiscussionPhase(game, currentPlayer, isLeader); break;
                case 'nomination': phaseContent = renderNominationPhase(game, currentPlayer, isLeader); break;
                case 'voting': phaseContent = renderVotingPhase(game, currentPlayer, isLeader); break;
                case 'missionTeamSelection': phaseContent = renderMissionTeamSelectionPhase(game, currentPlayer, isLeader); break;
                case 'missionVoting': phaseContent = renderMissionVotingPhase(game, currentPlayer, isLeader, isSpy); break;
                case 'missionResults': phaseContent = renderMissionResultsPhase(game, currentPlayer, isLeader); break;
                case 'tieDiscussion': phaseContent = renderTieDiscussionPhase(game); break;
                default: phaseContent = renderDiscussionPhase(game, currentPlayer, isLeader);
            }

            return `
                <div class="max-w-6xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
                        <div><h1 class="text-3xl font-bold text-blue-400">Игра</h1><p class="text-gray-300">Миссия ${game.currentMission}</p></div>
                        <div class="flex items-center space-x-4 mt-4 md:mt-0">
                            <div class="bg-gray-800 px-4 py-2 rounded"><p class="text-sm text-gray-400">Успех</p><p class="text-green-400 font-bold">${game.successfulMissions}</p></div>
                            <div class="bg-gray-800 px-4 py-2 rounded"><p class="text-sm text-gray-400">Провал</p><p class="text-red-400 font-bold">${game.failedMissions}</p></div>
                            <button onclick="returnToLobby()" class="bg-red-600 text-white py-2 px-4 rounded">Выйти</button>
                        </div>
                    </div>
                    <div class="mb-8">
                        <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 flex justify-between items-center">
                            <div class="flex items-center"><div class="w-3 h-3 rounded-full ${getPhaseColor(game.phase)} mr-3"></div><h2 class="text-xl font-bold text-white">${getPhaseTitle(game.phase)}</h2></div>
                            <div class="text-lg font-bold ${getTimerColor(game)}">${getTimerValue(game)} сек</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">${phaseContent}</div>
                        <div>${renderGameSidebar(game, me, isSpy, isLeader)}</div>
                    </div>
                </div>
            `;
        }
        
        function renderRoleRevealPhase(game) {
            const me = game.players.find(p => p.id === gameState.user.id);
            const isSpy = me.role === 'spy';
            const spyPlayers = isSpy ? (gameState.spiesList || []) : [];
            const roleName = isSpy ? 'Шпион' : 'Сопротивление';
            const roleColor = isSpy ? 'text-red-400' : 'text-green-400';
            const roleIcon = isSpy ? 'fa-user-secret' : 'fa-users';
            const roleBg = isSpy ? 'from-red-500 to-red-600' : 'from-green-500 to-emerald-600';

            if (me.confirmedRole) {
                const confirmedCount = game.players.filter(p => p.confirmedRole).length;
                return `
                    <div class="max-w-2xl mx-auto mt-12 text-center">
                        <div class="bg-gray-800 border border-gray-700 rounded-xl p-8 shadow-2xl">
                             <div class="mb-6"><i class="fas fa-check-circle text-green-500 text-6xl mb-4"></i><h2 class="text-3xl font-bold text-white mb-2">Вы подтвердили роль</h2><p class="text-gray-300">Ожидание других игроков... (${confirmedCount}/${game.players.length})</p></div>
                             <div class="w-full bg-gray-700 rounded-full h-4 mb-4"><div class="bg-blue-500 h-4 rounded-full transition-all duration-500" style="width: ${(confirmedCount/game.players.length)*100}%"></div></div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="max-w-md mx-auto mt-8">
                     <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-2xl text-center">
                        <h2 class="text-2xl font-bold text-white mb-6">Ваша роль в игре</h2>
                        <div class="role-card-inner relative w-full h-96 mb-6" style="transform: rotateY(0deg);">
                             <div class="absolute inset-0 w-full h-full bg-gray-800 border-2 ${isSpy ? 'border-red-900' : 'border-green-900'} rounded-xl flex flex-col items-center justify-center shadow-xl overflow-hidden">
                                <div class="absolute inset-0 opacity-10 ${isSpy ? 'bg-[url(\'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiPgo8cmVjdCB3aWR0aD0iOCIgaGVpZ2h0PSI4IiBmaWxsPSIjZmZmIi8+CjxwYXRoIGQ9Ik0wIDBMODIDOFpNOCAwTDAgOFoiIHN0cm9rZT0iIzAwMCIgc3Ryb2tlLXdpZHRoPSIxIi8+Cjwvc3ZnPg==\')]' : 'bg-[url(\'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+CjxjaXJjbGUgY3g9IjIiIGN5PSIyIiByPSIyIiBmaWxsPSIjZmZmIi8+Cjwvc3ZnPg==\')]'}"></div>
                                <div class="relative z-10 flex flex-col items-center w-full px-4">
                                    <div class="w-24 h-24 rounded-full bg-gradient-to-r ${roleBg} flex items-center justify-center text-white font-bold text-4xl mb-4 shadow-lg border-4 border-gray-800"><i class="fas ${roleIcon}"></i></div>
                                    <h3 class="text-3xl font-black ${roleColor} uppercase tracking-wider mb-2">${roleName}</h3>
                                    ${isSpy ? `<div class="bg-red-900/50 px-4 py-1 rounded text-red-200 font-mono text-lg mb-4 border border-red-800">Агент №${me.spyNumber}</div>` : ''}
                                    <div class="w-full bg-gray-900/60 rounded-lg p-4 backdrop-blur-sm border border-gray-700/50">
                                        ${isSpy ? `<p class="text-xs text-red-300 font-bold mb-2 uppercase border-b border-red-900/50 pb-1">Ваши союзники:</p><div class="space-y-2 max-h-32 overflow-y-auto custom-scrollbar">${spyPlayers.filter(s => s.id !== me.id).length > 0 ? spyPlayers.filter(s => s.id !== me.id).map(s => `<div class="flex items-center justify-between text-sm text-white bg-black/20 p-2 rounded"><span>${s.name}</span><span class="bg-red-900 px-2 rounded text-red-200 font-mono">${s.spyNumber}</span></div>`).join('') : '<span class="text-gray-400 text-sm italic">Нет других шпионов</span>'}</div>` : `<p class="text-base text-gray-300 text-center leading-relaxed">Ваша цель:<br><span class="text-green-400 font-bold text-xl">3 успешные миссии</span><br><span class="text-sm mt-2 block">Вы не знаете, кто шпионы.</span></p>`}
                                    </div>
                                </div>
                             </div>
                        </div>
                        <button onclick="confirmRole()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-bold py-4 px-6 rounded-lg text-xl shadow-lg transform hover:scale-105 transition-all"><i class="fas fa-check mr-2"></i>Я запомнил роль</button>
                     </div>
                </div>
            `;
        }
        function confirmRole() { sendAction('confirmRole'); if(gameState.gameData){ const me=gameState.gameData.players.find(p=>p.id===gameState.user.id); if(me)me.confirmedRole=true;} renderApp(); }

        function renderDiscussionPhase(game, currentPlayer, isLeader){
            const isCurrentPlayer = currentPlayer?.id === gameState.user.id;
            const isHost = gameState.currentRoom?.hostId === gameState.user.id;
            const isLeaderDiscussion = game.phase === 'leaderDiscussion';
            const actionName = isLeaderDiscussion ? 'passTurnLeaderDiscussion' : 'passTurn';
            const canPassTurn = isCurrentPlayer || isHost;
            const showNominationGrid = game.phase === 'discussion' || game.phase === 'nomination';
            return `
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg mb-6">
                    <div class="flex justify-between items-start mb-6">
                        <div><h2 class="text-2xl font-bold text-blue-400 flex items-center">${isLeaderDiscussion ? 'Обсуждение команды' : 'Обсуждение'}${game.players.find(p => p.isLeader)?.id ? `<span class="ml-3 text-sm bg-yellow-900 text-yellow-200 px-2 py-1 rounded-full border border-yellow-700"><i class="fas fa-crown mr-1"></i>Лидер: ${game.players.find(p => p.isLeader).name}</span>` : ''}</h2></div>
                        <div class="text-right"><div class="bg-gray-900 rounded-lg px-3 py-2 inline-block"><span class="text-gray-400 text-xs uppercase block">Таймер</span><span class="text-xl font-bold ${getTimerColor(game)}">${game.discussionTimeLeft} сек</span></div></div>
                    </div>
                    <div class="mb-8 flex flex-col items-center">
                        <div class="bg-gray-900/50 rounded-xl p-6 w-full max-w-2xl border border-gray-700/50 relative">
                            ${isCurrentPlayer ? `<div class="absolute top-0 right-0 -mt-2 -mr-2"><span class="animate-ping absolute inline-flex h-4 w-4 rounded-full bg-blue-400 opacity-75"></span><span class="relative inline-flex rounded-full h-4 w-4 bg-blue-500"></span></div>` : ''}
                            <div class="flex flex-col items-center text-center">
                                <div class="relative">${currentPlayer?.isLeader ? '<div class="absolute -top-4 left-1/2 transform -translate-x-1/2 text-yellow-400 text-2xl"><i class="fas fa-crown"></i></div>' : ''}<div class="w-20 h-20 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 flex items-center justify-center text-white font-bold text-3xl mb-4 ring-4 ${isCurrentPlayer ? 'ring-blue-500 shadow-[0_0_20px_rgba(59,130,246,0.5)]' : 'ring-blue-500/30'} transition-all duration-300">${(currentPlayer?.name || '?').charAt(0)}</div></div>
                                <h3 class="text-2xl font-bold text-white mb-1">${currentPlayer?.name || ''}</h3>
                                <p class="text-blue-300 mb-6 font-medium">${isCurrentPlayer ? 'ВАШ ХОД! Выскажите свои мысли.' : 'Слушайте игрока'}</p>
                                ${canPassTurn ? `<button onclick="sendAction('${actionName}')" class="bg-blue-600 text-white font-semibold py-3 px-8 rounded-full shadow-lg flex items-center animate-bounce-slow"><i class="fas fa-step-forward mr-2"></i>Завершить ход</button>${isHost && !isCurrentPlayer ? '<p class="text-xs text-gray-500 mt-2">(Как создатель вы можете пропустить ход)</p>' : ''}` : `<div class="h-2 w-full max-w-xs bg-gray-700 rounded-full overflow-hidden"><div class="h-full bg-blue-500 transition-all duration-1000 ease-linear" style="width: ${(game.discussionTimeLeft/40)*100}%"></div></div>`}
                            </div>
                        </div>
                    </div>
                    ${showNominationGrid ? `<div class="mb-6 animate-fade-in"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-semibold text-white">Выдвижение кандидатов</h3><p class="text-xs text-gray-400">Нажмите на игрока, чтобы выдвинуть</p></div><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">${game.players.map((p)=>{const isCurrent=p.id===currentPlayer?.id;const isNominated=(game.nominatedPlayers||[]).includes(p.name);const isMe=p.id===gameState.user.id;const isLeader=p.isLeader;return `<div onclick="handlePlayerClick('${p.name}')" class="cursor-pointer relative bg-gray-800 border ${isNominated ? 'border-purple-500 ring-2 ring-purple-500 shadow' : 'border-gray-600 hover:border-gray-400'} rounded-lg p-3 flex flex-col items-center transition-all group select-none">${isNominated ? '<div class="absolute top-2 right-2 text-purple-400 text-xl"><i class="fas fa-check-circle"></i></div>' : ''}${isLeader ? '<div class="absolute top-2 left-2 text-yellow-400 text-sm"><i class="fas fa-crown"></i></div>' : ''}<div class="w-12 h-12 rounded-full ${isCurrent ? 'bg-blue-600 ring-2 ring-white' : 'bg-gray-700'} flex items-center justify-center text-white font-bold mb-2 transition-colors">${isCurrent ? '<i class="fas fa-microphone"></i>' : p.name.charAt(0)}</div><span class="text-sm font-semibold ${isNominated ? 'text-purple-300' : 'text-gray-300'} truncate w-full text-center">${p.name}</span><span class="text-xs text-gray-500">${isMe ? '(Вы)' : ''}</span></div>`;}).join('')}</div></div>` : ''}
                </div>
            `;
        }

        function renderNominationPhase(game){ return renderDiscussionPhase(game, game.players[game.currentPlayerIndex], false); }

        function renderVotingPhase(game){
            const me = game.players.find(p=>p.id===gameState.user.id) || {};
            const hasVoted = !!me.voted;
            const candidates = (game.tieCandidates && game.tieCandidates.length > 0) ? game.tieCandidates : game.nominatedPlayers;
            return `
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-yellow-400 mb-6">Голосование за лидера</h2>
                    ${hasVoted?`<div class="bg-yellow-900/30 border border-yellow-700 rounded-lg p-4 mb-6"><div class="flex items-center"><i class="fas fa-vote-yea text-yellow-400 text-2xl mr-3"></i><div><p class="text-white font-semibold">Вы уже проголосовали</p><p class="text-yellow-300 text-sm">Ожидаем остальных...</p></div></div></div>`:''}
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                        ${candidates.map(name=>{const isMe=(game.players.find(p=>p.name===name)?.id===gameState.user.id);return `<div class="bg-gray-800 border ${isMe?'border-blue-500':'border-gray-700'} rounded-xl p-4 text-center"><div class="w-16 h-16 rounded-full bg-orange-600 mx-auto flex items-center justify-center text-white font-bold text-xl mb-3">${name.charAt(0)}</div><h3 class="font-bold text-white text-lg mb-1">${name}</h3><p class="text-gray-400 text-sm mb-4">${isMe?'Вы':'Кандидат'}</p>${!hasVoted?`<button onclick="voteForLeader('${name}')" class="w-full bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg"><i class="fas fa-check mr-2"></i>Выбрать</button>`:''}</div>`;}).join('')}
                    </div>
                    <div class="text-center"><p class="text-gray-400">Проголосовали: ${Object.keys(game.votes).length} из ${game.players.length}</p></div>
                </div>
            `;
        }
        function renderLeaderSelectionPhase(game){ /* Unused */ return ''; }
        function renderMissionTeamSelectionPhase(game, currentPlayer, isLeader){
            const missionSize = game.missionSizes[game.currentMission-1];
            const currentTeamSize = game.missionTeam.length;
            const isTeamFull = currentTeamSize >= missionSize;
            return `
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-green-400 mb-6">Формирование команды</h2>
                    <div class="flex justify-between items-center mb-6"><div><p class="text-gray-300">Лидер: <span class="font-bold text-white">${currentPlayer?.name || ''}</span></p><p class="text-gray-300">Нужно: <span class="font-bold text-white">${missionSize} игроков</span></p></div><div class="bg-gray-900 rounded-lg p-3"><div class="flex justify-between items-center mb-1"><span class="text-gray-300">Время:</span><span class="text-xl font-bold ${getTimerColor(game)}">${game.nominationTimeLeft} сек</span></div></div></div>
                    <div class="mb-8"><h3 class="text-lg font-semibold text-white mb-4">Выбранные:</h3>${game.missionTeam.length>0?`<div class="flex flex-wrap gap-3 mb-4">${game.missionTeam.map(n=>`<div class="bg-green-900/30 border border-green-700 rounded-full px-4 py-2 flex items-center"><i class="fas fa-user-check text-green-400 mr-2"></i><span class="text-white font-semibold">${n}</span>${isLeader?`<button onclick=\"removeFromMissionTeam('${n}')\" class=\"ml-2 text-red-400\"><i class='fas fa-times'></i></button>`:''}</div>`).join('')}</div><p class="text-gray-400">Выбрано: ${currentTeamSize} из ${missionSize}</p>`:`<p class="text-gray-400 italic">Пусто</p>`}</div>
                    ${isLeader?`<div class="mb-8"><h3 class="text-lg font-semibold text-white mb-4">Выберите игроков:</h3><div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">${game.players.map(p=>{const isInTeam=game.missionTeam.includes(p.name);return `<div class="bg-gray-800 border ${isInTeam?'border-green-500':'border-gray-700'} rounded-xl p-4 text-center"><div class="w-12 h-12 rounded-full ${isInTeam?'bg-green-600':'bg-blue-600'} mx-auto mb-3 flex items-center justify-center text-white font-bold">${p.name.charAt(0)}</div><h3 class="font-bold text-white mb-1">${p.name}</h3><button onclick="${isInTeam?`removeFromMissionTeam('${p.name}')`:`addToMissionTeam('${p.name}')`}" class="w-full ${isInTeam?'bg-red-600':'bg-blue-600'} text-white font-semibold py-2 px-4 rounded-lg" ${!isInTeam&&isTeamFull?'disabled':''}>${isInTeam?'Убрать':'Добавить'}</button></div>`;}).join('')}</div></div><div class="flex justify-center space-x-4"><button onclick="approveMissionTeam()" class="bg-green-600 text-white font-semibold py-3 px-8 rounded-lg text-lg" ${!isTeamFull?'disabled':''}>Утвердить</button><button onclick="resetMissionTeam()" class="bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg">Сброс</button></div>`:`<div class="bg-gray-900 rounded-xl p-5"><div class="flex items-center"><i class="fas fa-hourglass-half text-green-400 text-2xl mr-3"></i><div><p class="text-white font-semibold">Ожидание лидера</p></div></div></div>`}
                </div>
            `;
        }
        function renderMissionVotingPhase(game, currentPlayer, isLeader, isSpy){
            const me = game.players.find(p=>p.id===gameState.user.id)||{};
            const hasVoted = me.missionVote!==null && me.missionVote!==undefined;
            const isInMission = game.missionTeam.includes(me.name||'');
            return `
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-orange-400 mb-6">Голосование за миссию</h2>
                    ${isInMission?`${hasVoted?`<div class="bg-orange-900/30 border border-orange-700 rounded-lg p-4 mb-6"><div class="flex items-center"><i class="fas fa-vote-yea text-orange-400 text-2xl mr-3"></i><div><p class="text-white font-semibold">Вы проголосовали</p><p class="text-orange-300 text-sm">Ожидание остальных...</p></div></div></div>`:`<div class="relative h-64 bg-gray-900 rounded-xl flex items-center justify-center gap-8"><button onclick="voteForMission('success')" class="w-32 h-32 rounded-full bg-green-600 hover:bg-green-700 text-white font-bold flex flex-col items-center justify-center shadow-lg transform hover:scale-110 transition-all"><i class="fas fa-check text-4xl mb-2"></i>Успех</button>${isSpy?`<button onclick="voteForMission('fail')" class="w-32 h-32 rounded-full bg-red-600 hover:bg-red-700 text-white font-bold flex flex-col items-center justify-center shadow-lg transform hover:scale-110 transition-all"><i class="fas fa-times text-4xl mb-2"></i>Провал</button>`:''}</div>`}`:`<div class="bg-gray-900 rounded-xl p-5"><div class="flex items-center"><i class="fas fa-hourglass-half text-orange-400 text-2xl mr-3"></i><div><p class="text-white font-semibold">Вы не в миссии</p><p class="text-orange-300">Ожидание результатов</p></div></div></div>`}
                    <div class="text-center mt-4"><p class="text-gray-400">Проголосовали: ${Object.keys(game.missionVotes).length} из ${game.missionTeam.length}</p></div>
                </div>
            `;
        }
        function renderMissionResultsPhase(game){
            const last = game.missionResults[game.missionResults.length-1]||{};
            return `
                <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
                    <h2 class="text-2xl font-bold text-red-400 mb-6">Результаты миссии ${last.mission}</h2>
                    <div class="flex flex-col items-center text-center mb-8">
                        <div class="w-32 h-32 rounded-full ${last.success?'bg-green-600':'bg-red-600'} flex items-center justify-center text-white font-bold text-4xl mb-4">${last.success?'<i class="fas fa-check"></i>':'<i class="fas fa-times"></i>'}</div>
                        <h3 class="font-bold text-white text-3xl mb-2">${last.success?'УСПЕХ!':'ПРОВАЛ!'}</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-gray-900 rounded-xl p-5"><h4 class="text-lg font-bold text-white mb-3">Голоса:</h4><div class="space-y-3"><div class="flex justify-between items-center"><span class="text-gray-300">За успех:</span><span class="text-2xl font-bold text-green-400">${last.successCount||0}</span></div><div class="flex justify-between items-center"><span class="text-gray-300">За провал:</span><span class="text-2xl font-bold text-red-400">${last.failCount||0}</span></div></div></div>
                        <div class="bg-gray-900 rounded-xl p-5"><h4 class="text-lg font-bold text-white mb-3">Общий счёт:</h4><div class="space-y-3"><div class="flex justify-between items-center"><span class="text-gray-300">Успехов:</span><span class="text-2xl font-bold text-green-400">${game.successfulMissions}</span></div><div class="flex justify-between items-center"><span class="text-gray-300">Провалов:</span><span class="text-2xl font-bold text-red-400">${game.failedMissions}</span></div></div></div>
                    </div>
                    ${game.gameOver?`<div class="bg-gradient-to-r ${game.winner==='resistance'?'from-green-900 to-green-800':'from-red-900 to-red-800'} rounded-xl p-5 mb-8 text-center"><h3 class="text-2xl font-bold text-white mb-2">ИГРА ОКОНЧЕНА!</h3><p class="text-xl font-bold text-white">Победила команда ${game.winner==='resistance'?'СОПРОТИВЛЕНИЯ':'ШПИОНОВ'}!</p></div><div class="text-center"><button onclick="returnToLobby()" class="bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg text-lg">В лобби</button></div>`:`<div class="text-center"><button onclick="startNextMission()" class="bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg text-lg">Далее</button></div>`}
                </div>
            `;
        }
        function renderTieDiscussionPhase(game){
            return `<div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg"><h2 class="text-2xl font-bold text-pink-400 mb-6">Ничья</h2><p class="text-gray-300 mb-4">Игроки: ${(game.tieCandidates||[]).join(', ')} обсуждают по 30 секунд. Таймер: ${game.tieTimeLeft}</p></div>`;
        }

        function renderGameSidebar(game, me, isSpy, isLeader){
            return `
                <div class="space-y-6">
                    <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
                        <h2 class="text-xl font-bold text-white mb-4">Миссии</h2>
                        <div class="space-y-4">
                            <div><h3 class="text-gray-300 mb-1">Текущая:</h3><p class="text-white font-bold text-lg">${getMissionName(game.currentMission)}</p></div>
                        </div>
                        <div class="mt-6 pt-6 border-t border-gray-700">
                            ${game.missionSizes.map((size,idx)=>{const m=idx+1;const isCur=m===game.currentMission;const res=game.missionResults[idx];return `<div class=\"flex items-center justify-between ${isCur?'bg-blue-900/30 p-2 rounded':''}\"><div class=\"flex items-center\"><div class=\"w-8 h-8 rounded-full ${isCur?'bg-blue-600':res?(res.success?'bg-green-600':'bg-red-600'):'bg-gray-700'} flex items-center justify-center text-white text-sm font-bold mr-3\">${m}</div><span class=\"${isCur?'text-blue-300 font-bold':'text-gray-300'}\">Миссия ${m}: ${size}</span></div>${res?`<span class=\"text-sm ${res.success?'text-green-400':'text-red-400'}\">${res.success?'✓':'✗'}</span>`:''}</div>`;}).join('')}
                        </div>
                    </div>
                    <div class="bg-gray-800 border border-gray-700 rounded-xl p-6 shadow-lg">
                        <h2 class="text-xl font-bold text-white mb-4">Игроки</h2>
                        <div class="space-y-3">
                            ${game.players.map(p=>{const isMe=p.id===gameState.user.id;const isLead=p.isLeader;const inTeam=(game.missionTeam||[]).includes(p.name);const isNom=(game.nominatedPlayers||[]).includes(p.name);return `<div class="flex items-center justify-between ${isMe?'bg-blue-900/30 p-2 rounded':''}"><div class="flex items-center"><div class="relative"><div class="w-10 h-10 rounded-full ${isLead?'bg-yellow-600 ring-2 ring-yellow-400':isMe?'bg-blue-600':'bg-gray-700'} flex items-center justify-center text-white font-bold mr-3">${p.name.charAt(0)}</div>${isLead ? '<div class="absolute -top-1 -right-1 text-yellow-400 text-xs bg-gray-800 rounded-full px-1"><i class="fas fa-crown"></i></div>' : ''}</div><div><h3 class="font-semibold ${isMe?'text-blue-300':'text-white'} flex items-center">${p.name}${isLead ? '<span class="ml-2 text-xs text-yellow-400 font-normal"><i class="fas fa-crown mr-1"></i>Лидер</span>' : ''}</h3><p class="text-xs text-gray-400">${isMe?'Вы':'Игрок'}${inTeam?' • В миссии':''}${isNom?' • Кандидат':''}</p></div></div></div>`;}).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // --- Helpers ---
        function getPhaseColor(phase){ switch(phase){case 'discussion':return 'bg-blue-500';case 'leaderDiscussion':return 'bg-blue-500';case 'nomination':return 'bg-purple-500';case 'voting':return 'bg-yellow-500';case 'missionTeamSelection':return 'bg-green-500';case 'missionVoting':return 'bg-orange-500';case 'missionResults':return 'bg-red-500';case 'tieDiscussion':return 'bg-pink-500';default:return 'bg-gray-500';} }
        function getPhaseTitle(phase){ switch(phase){case 'discussion':return 'Обсуждение';case 'leaderDiscussion':return 'Обсуждение команды';case 'nomination':return 'Выдвижение';case 'voting':return 'Голосование';case 'missionTeamSelection':return 'Команда миссии';case 'missionVoting':return 'Голосование миссии';case 'missionResults':return 'Результаты';case 'tieDiscussion':return 'Ничья';default:return 'Фаза';} }
        function getTimerColor(game){ return 'text-green-400'; }
        function getTimerValue(game) { if (game.phase === 'discussion' || game.phase === 'leaderDiscussion') return game.discussionTimeLeft; if (game.phase === 'missionTeamSelection') return game.nominationTimeLeft; if (game.phase === 'tieDiscussion') return game.tieTimeLeft; return 0; }
        function getMissionName(n){const names=["Рассвет","Тишина","Обман","Восход","Феникс"];return names[n-1]||`Миссия ${n}`}
        function getSpyCount(pc){ pc=parseInt(pc); if(pc===5) return 2; if(pc===6) return 2; if(pc===7) return 3; if(pc===8) return 3; if(pc===9) return 3; return 2; }
        function getResistanceCount(pc){ return pc - getSpyCount(pc); }
        function showHelp() { alert(`Инструкция...`); }
        function promptServerUrl(){ const c = wsUrl(); const i = prompt('Сервер:', c); if (i) { localStorage.setItem('resistanceServerWsUrl', i); gameState.serverWsUrl = i; connectWS(); } }
        function reconnectNow(){ connectWS(); }

        // Actions
        function passTurn() { sendAction('passTurn'); }
        function sendAction(name, extra = {}) { sendWS({ type: 'action', action: { name, ...extra } }); }
        function handlePlayerClick(playerName) {
            const game = gameState.gameData;
            if (!game) return;
            if (game.phase === 'discussion' || game.phase === 'nomination') {
                const isNominated = (game.nominatedPlayers || []).includes(playerName);
                if (isNominated) { sendAction('removeNomination', { playerName }); } else { if (playerName === gameState.user.name) sendAction('nominateSelf'); else sendAction('nominateOther', { playerName }); }
            }
        }
        function voteForLeader(name){ sendAction('voteForLeader',{playerName:name}); }
        function addToMissionTeam(name){ sendAction('addToMissionTeam',{playerName:name}); }
        function removeFromMissionTeam(name){ sendAction('removeFromMissionTeam',{playerName:name}); }
        function resetMissionTeam(){ sendAction('resetMissionTeam'); }
        function approveMissionTeam(){ sendAction('approveMissionTeam'); }
        function voteForMission(vote){ if(gameState.gameData){const me=gameState.gameData.players.find(p=>p.id===gameState.user.id);if(me)me.missionVote=vote;} renderApp(); sendAction('voteForMission',{vote}); }
        function startNextMission(){ sendAction('startNextMission'); }
        function returnToLobby(){ gameState.currentRoom=null; gameState.gameData=null; gameState.currentView='lobby'; renderApp(); }
    </script>
</body>
</html>
